<!doctype html>
<html>
<head>
  <meta charset="UTF-8">
  <style>
    /* ===== è‡ªå®šä¹‰é¢œè‰²å˜é‡ ===== */
    :root {
      --color-user-message: #60A5FA;
      --color-ai-response: #E0E0E0;
      --color-code-block: #A78BFA;
      --color-action-status: #4ADE80;
      --color-thinking: #9CA3AF;
      --bg-modal: #1e1e1e;
      --border-color: #3c3c3c;
      --accent-color: #667eea;
      --text-main: #fff;
      --text-sub: #999;
    }

    /* ===== æ‚¬æµ®æŒ‰é’®æ ·å¼ ===== */
    #settings-toggle-btn {
      position: fixed;
      right: 0;
      top: 66%;
      transform: translateY(-50%);
      width: 28px;
      height: 48px;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      border: none;
      border-radius: 8px 0 0 8px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      box-shadow: -2px 2px 8px rgba(0,0,0,0.3);
      z-index: 9999;
      transition: all 0.3s ease;
    }
    #settings-toggle-btn:hover {
      width: 36px;
      background: linear-gradient(135deg, #764ba2 0%, #667eea 100%);
    }
    #settings-toggle-btn svg {
      width: 18px;
      height: 18px;
      fill: white;
      transition: transform 0.3s ease;
    }
    #settings-toggle-btn:hover svg {
      transform: rotate(90deg);
    }

    /* ===== å¼¹çª—é®ç½©å±‚ ===== */
    #settings-overlay {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0,0,0,0.5);
      z-index: 10000;
      display: none;
      opacity: 0;
      transition: opacity 0.3s ease;
      align-items: center;
      justify-content: center;
    }
    #settings-overlay.show {
      display: flex;
    }
    #settings-overlay.visible {
      opacity: 1;
    }

    /* ===== è®¾ç½®å¼¹çª— ===== */
    #settings-modal {
      background: var(--bg-modal);
      border-radius: 12px;
      width: 400px;
      max-width: 90%;
      max-height: 85vh;
      display: flex;
      flex-direction: column;
      box-shadow: 0 8px 32px rgba(0,0,0,0.4);
      border: 1px solid var(--border-color);
      transform: scale(0.9);
      transition: transform 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
      overflow: hidden;
    }
    #settings-overlay.visible #settings-modal {
      transform: scale(1);
    }
    
    /* å¼¹çª— Header */
    .modal-header {
      padding: 16px 20px;
      border-bottom: 1px solid var(--border-color);
      display: flex;
      justify-content: space-between;
      align-items: center;
      background: rgba(255,255,255,0.02);
    }
    .header-left {
      display: flex;
      flex-direction: column;
    }
    .brand-name {
      color: var(--text-main);
      font-size: 16px;
      font-weight: 700;
      background: linear-gradient(90deg, #fff, #a5b4fc);
      -webkit-background-clip: text;
      background-clip: text;
      -webkit-text-fill-color: transparent;
    }
    .brand-links {
      display: flex;
      gap: 12px;
      margin-top: 4px;
    }
    .brand-link {
      color: var(--text-sub);
      font-size: 10px;
      text-decoration: none;
      transition: color 0.2s;
    }
    .brand-link:hover {
      color: var(--accent-color);
    }
    .header-right {
      display: flex;
      align-items: center;
      gap: 12px;
    }
    .lang-switch {
      background: none;
      border: 1px solid var(--border-color);
      color: var(--text-sub);
      font-size: 11px;
      padding: 4px 8px;
      border-radius: 4px;
      cursor: pointer;
      transition: all 0.2s;
    }
    .lang-switch:hover {
      border-color: var(--text-main);
      color: var(--text-main);
    }
    .modal-close {
      background: none;
      border: none;
      color: var(--text-sub);
      font-size: 20px;
      cursor: pointer;
      padding: 0;
      line-height: 1;
      transition: color 0.2s;
    }
    .modal-close:hover {
      color: var(--text-main);
    }

    /* é€‰é¡¹å¡å¯¼èˆª */
    .tab-nav {
      display: flex;
      border-bottom: 1px solid var(--border-color);
      padding: 0 10px;
      background: rgba(0,0,0,0.1);
    }
    .tab-btn {
      flex: 1;
      background: none;
      border: none;
      color: var(--text-sub);
      padding: 12px;
      font-size: 13px;
      cursor: pointer;
      position: relative;
      transition: all 0.2s;
    }
    .tab-btn:hover {
      color: var(--text-main);
    }
    .tab-btn.active {
      color: var(--accent-color);
      font-weight: 600;
    }
    .tab-btn.active::after {
      content: '';
      position: absolute;
      bottom: -1px;
      left: 0;
      width: 100%;
      height: 2px;
      background: var(--accent-color);
    }

    /* å†…å®¹åŒºåŸŸ */
    .modal-body {
      flex: 1;
      overflow-y: auto;
      padding: 0;
    }
    .tab-content {
      display: none;
      animation: fadeIn 0.2s ease;
    }
    .tab-content.active {
      display: block;
    }
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(5px); }
      to { opacity: 1; transform: translateY(0); }
    }

    /* æ‰‹é£ç´æ•ˆæœ */
    .accordion-item {
      border-bottom: 1px solid var(--border-color);
    }
    .accordion-header {
      padding: 14px 20px;
      background: rgba(255,255,255,0.01);
      cursor: pointer;
      display: flex;
      justify-content: space-between;
      align-items: center;
      transition: background 0.2s;
    }
    .accordion-header:hover {
      background: rgba(255,255,255,0.03);
    }
    .accordion-title {
      font-size: 13px;
      font-weight: 600;
      color: var(--text-main);
      display: flex;
      align-items: center;
      gap: 8px;
    }
    .accordion-icon {
      font-size: 10px;
      color: var(--text-sub);
      transition: transform 0.3s;
    }
    .accordion-item.expanded .accordion-icon {
      transform: rotate(180deg);
    }
    .accordion-body {
      max-height: 0;
      overflow: hidden;
      transition: max-height 0.3s cubic-bezier(0, 1, 0, 1);
      background: rgba(0,0,0,0.1);
    }
    .accordion-item.expanded .accordion-body {
      max-height: 1000px; /* è¶³å¤Ÿå¤§çš„å€¼ */
      transition: max-height 0.3s ease-in-out;
    }
    .accordion-inner {
      padding: 16px 20px;
    }

    /* é€šç”¨æ§ä»¶æ ·å¼ */
    .main-toggle {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 10px 12px;
      background: rgba(102, 126, 234, 0.1);
      border: 1px solid rgba(102, 126, 234, 0.2);
      border-radius: 8px;
      margin-bottom: 12px;
    }
    .main-toggle-label {
      color: var(--text-main);
      font-size: 13px;
      font-weight: 500;
    }

    .setting-item {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 8px 0;
      border-bottom: 1px solid rgba(255,255,255,0.05);
    }
    .setting-item:last-child {
      border-bottom: none;
    }
    .setting-left {
      display: flex;
      align-items: center;
      gap: 10px;
    }
    .setting-icon {
      font-size: 15px;
      width: 20px;
      text-align: center;
      color: var(--text-sub);
    }
    .setting-name {
      color: #ccc;
      font-size: 13px;
    }
    .setting-right {
      display: flex;
      align-items: center;
      gap: 8px;
    }
    
    /* Toggle Switch */
    .toggle-switch {
      position: relative;
      width: 32px;
      height: 18px;
    }
    .toggle-switch input {
      opacity: 0;
      width: 0;
      height: 0;
    }
    .toggle-slider {
      position: absolute;
      cursor: pointer;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background-color: #3c3c3c;
      transition: 0.3s;
      border-radius: 20px;
    }
    .toggle-slider:before {
      position: absolute;
      content: "";
      height: 12px;
      width: 12px;
      left: 3px;
      bottom: 3px;
      background-color: white;
      transition: 0.3s;
      border-radius: 50%;
    }
    .toggle-switch input:checked + .toggle-slider {
      background: var(--accent-color);
    }
    .toggle-switch input:checked + .toggle-slider:before {
      transform: translateX(14px);
    }

    /* Color Input */
    .color-input {
      width: 24px;
      height: 24px;
      border: 1px solid var(--border-color);
      border-radius: 4px;
      cursor: pointer;
      padding: 0;
      background: none;
    }
    .color-input::-webkit-color-swatch-wrapper {
      padding: 2px;
    }
    .color-input::-webkit-color-swatch {
      border-radius: 2px;
      border: none;
    }

    /* Select Input */
    .select-input {
      background: #2d2d2d;
      border: 1px solid var(--border-color);
      border-radius: 6px;
      padding: 4px 8px;
      color: #ccc;
      font-size: 12px;
      cursor: pointer;
      outline: none;
      min-width: 110px;
    }
    .select-input:focus {
      border-color: var(--accent-color);
    }

    /* ===== é¢œè‰²è¦†ç›–æ ·å¼ ===== */
    /* ç”¨æˆ·æ¶ˆæ¯ */
    #react-app.color-user-message .bg-gray-500\/15 .whitespace-pre-wrap,
    #react-app.color-user-message .bg-gray-500\/15 [style*="word-break"] {
      color: var(--color-user-message) !important;
    }
    /* AIå›å¤ (æ’é™¤æ€è€ƒ) */
    #react-app.color-ai-response .prose:not(.opacity-70) p,
    #react-app.color-ai-response .prose:not(.opacity-70) li,
    #react-app.color-ai-response .prose:not(.opacity-70) h2,
    #react-app.color-ai-response .prose:not(.opacity-70) h3,
    #react-app.color-ai-response .prose:not(.opacity-70) strong,
    #react-app.color-ai-response .prose:not(.opacity-70) ul,
    #react-app.color-ai-response .prose:not(.opacity-70) ol,
    #react-app.color-ai-response .prose:not(.opacity-70) table,
    #react-app.color-ai-response .prose:not(.opacity-70) th,
    #react-app.color-ai-response .prose:not(.opacity-70) td {
      color: var(--color-ai-response) !important;
    }
    /* ä»£ç å— */
    #react-app.color-code-block pre,
    #react-app.color-code-block pre code,
    #react-app.color-code-block .code-block,
    #react-app.color-code-block .code-line {
      color: var(--color-code-block) !important;
    }
    /* æ“ä½œçŠ¶æ€ */
    #react-app.color-action-status .shrink-0:is(:contains('Analyzed'), :contains('Created'), :contains('Edited')),
    #react-app.color-action-status [class*="animate-fade-in"] .truncate {
      color: var(--color-action-status) !important;
    }
    /* æ€è€ƒè¿‡ç¨‹ */
    #react-app.color-thinking .opacity-70.prose,
    #react-app.color-thinking .opacity-70.prose * {
      color: var(--color-thinking) !important;
    }

    /* ===== å¤åˆ¶æŒ‰é’®æ ·å¼ ===== */
    .copy-btn {
      position: absolute;
      top: 6px;
      right: 6px;
      width: 26px;
      height: 26px;
      background: rgba(60, 60, 60, 0.9);
      border: 1px solid rgba(255,255,255,0.1);
      border-radius: 5px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      opacity: 0;
      transition: all 0.2s ease;
      z-index: 10;
    }
    .copy-btn svg {
      width: 14px;
      height: 14px;
      fill: #ccc;
    }
    .copy-btn:hover {
      background: rgba(102, 126, 234, 0.8);
      border-color: rgba(102, 126, 234, 0.5);
    }
    .copy-btn:hover svg {
      fill: #fff;
    }
    .copy-btn.copied {
      background: rgba(74, 222, 128, 0.8);
    }
    .copy-btn.copied svg {
      fill: #fff;
    }
    .copy-target { position: relative; }
    .copy-target:hover .copy-btn { opacity: 1; }

    /* ===== Toast æç¤ºæ ·å¼ ===== */
    #retry-toast {
      position: fixed;
      top: 50px;
      left: 50%;
      transform: translateX(-50%);
      background: rgba(0, 0, 0, 0.85);
      color: white;
      padding: 10px 20px;
      border-radius: 20px;
      font-size: 13px;
      z-index: 20000;
      display: none;
      opacity: 0;
      transition: opacity 0.3s ease, top 0.3s ease;
      align-items: center;
      gap: 10px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.3);
      border: 1px solid rgba(255,255,255,0.1);
    }
    #retry-toast.show {
      display: flex;
      opacity: 1;
      top: 60px;
    }
    #retry-toast.success {
      background: rgba(46, 125, 50, 0.9);
      border-color: rgba(76, 175, 80, 0.3);
    }
    .toast-spinner {
      width: 14px;
      height: 14px;
      border: 2px solid rgba(255,255,255,0.3);
      border-top: 2px solid #fff;
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
  </style>
</head>
<body style="margin: 0">
  <div id="react-app" class="react-app-container"></div>
  
  <div id="retry-toast">
    <div class="toast-spinner"></div>
    <span id="retry-toast-text"></span>
  </div>
  
  <!-- æ‚¬æµ®è®¾ç½®æŒ‰é’® -->
  <button id="settings-toggle-btn" title="Open Settings">
    <svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
      <path d="M19.14,12.94c0.04-0.31,0.06-0.63,0.06-0.94c0-0.31-0.02-0.63-0.06-0.94l2.03-1.58c0.18-0.14,0.23-0.41,0.12-0.61 l-1.92-3.32c-0.12-0.22-0.37-0.29-0.59-0.22l-2.39,0.96c-0.5-0.38-1.03-0.7-1.62-0.94L14.4,2.81c-0.04-0.24-0.24-0.41-0.48-0.41 h-3.84c-0.24,0-0.43,0.17-0.47,0.41L9.25,5.35C8.66,5.59,8.12,5.92,7.63,6.29L5.24,5.33c-0.22-0.08-0.47,0-0.59,0.22L2.74,8.87 C2.62,9.08,2.66,9.34,2.86,9.48l2.03,1.58C4.84,11.37,4.8,11.69,4.8,12s0.02,0.63,0.06,0.94l-2.03,1.58 c-0.18,0.14-0.23,0.41-0.12,0.61l1.92,3.32c0.12,0.22,0.37,0.29,0.59,0.22l2.39-0.96c0.5,0.38,1.03,0.7,1.62,0.94l0.36,2.54 c0.05,0.24,0.24,0.41,0.48,0.41h3.84c0.24,0,0.44-0.17,0.47-0.41l0.36-2.54c0.59-0.24,1.13-0.56,1.62-0.94l2.39,0.96 c0.22,0.08,0.47,0,0.59-0.22l1.92-3.32c0.12-0.22,0.07-0.47-0.12-0.61L19.14,12.94z M12,15.6c-1.98,0-3.6-1.62-3.6-3.6 s1.62-3.6,3.6-3.6s3.6,1.62,3.6,3.6S13.98,15.6,12,15.6z"/>
    </svg>
  </button>

  <!-- è®¾ç½®å¼¹çª— -->
  <div id="settings-overlay">
    <div id="settings-modal">
      <!-- Header -->
      <div class="modal-header">
        <div class="header-left">
          <span class="brand-name">Antigravity Better</span>
          <div class="brand-links">
            <a href="https://dpit.lib00.com" target="_blank" class="brand-link">ğŸŒ dpit.lib00.com</a>
            <a href="https://github.com/016/Antigravity-Better" target="_blank" class="brand-link">ğŸ“¦ GitHub</a>
          </div>
        </div>
        <div class="header-right">
          <button class="lang-switch" id="lang-switch">ğŸŒ En/ä¸­</button>
          <button class="modal-close" id="modal-close-btn">&times;</button>
        </div>
      </div>

      <!-- Tabs -->
      <div class="tab-nav">
        <button class="tab-btn active" data-tab="appearance" data-i18n="tab_appearance">ğŸ¨ å¤–è§‚</button>
        <button class="tab-btn" data-tab="features" data-i18n="tab_features">ğŸ› ï¸ åŠŸèƒ½</button>
      </div>

      <!-- Content -->
      <div class="modal-body">
        <!-- Tab: Appearance -->
        <div class="tab-content active" id="tab-appearance">
          <!-- Accordion: Colors -->
          <div class="accordion-item expanded">
            <div class="accordion-header">
              <span class="accordion-title" data-i18n="colors_title">ğŸ¨ é¢œè‰²è‡ªå®šä¹‰</span>
              <span class="accordion-icon">â–¼</span>
            </div>
            <div class="accordion-body">
              <div class="accordion-inner">
                <div class="main-toggle">
                  <span class="main-toggle-label" data-i18n="enable_custom_colors">å¯ç”¨è‡ªå®šä¹‰é¢œè‰²</span>
                  <label class="toggle-switch">
                    <input type="checkbox" id="master-toggle">
                    <span class="toggle-slider"></span>
                  </label>
                </div>
                
                <div id="color-settings">
                  <div class="setting-item">
                    <div class="setting-left">
                      <span class="setting-icon">ğŸ“</span>
                      <span class="setting-name" data-i18n="lbl_user_msg">ç”¨æˆ·æ¶ˆæ¯</span>
                    </div>
                    <div class="setting-right">
                      <label class="toggle-switch">
                        <input type="checkbox" id="toggle-user-message" checked>
                        <span class="toggle-slider"></span>
                      </label>
                      <input type="color" id="color-user-message" class="color-input" value="#60A5FA">
                    </div>
                  </div>

                  <div class="setting-item">
                    <div class="setting-left">
                      <span class="setting-icon">ğŸ¤–</span>
                      <span class="setting-name" data-i18n="lbl_ai_resp">AIå›å¤</span>
                    </div>
                    <div class="setting-right">
                      <label class="toggle-switch">
                        <input type="checkbox" id="toggle-ai-response" checked>
                        <span class="toggle-slider"></span>
                      </label>
                      <input type="color" id="color-ai-response" class="color-input" value="#E0E0E0">
                    </div>
                  </div>

                  <div class="setting-item">
                    <div class="setting-left">
                      <span class="setting-icon">ğŸ’»</span>
                      <span class="setting-name" data-i18n="lbl_code">ä»£ç å—</span>
                    </div>
                    <div class="setting-right">
                      <label class="toggle-switch">
                        <input type="checkbox" id="toggle-code-block" checked>
                        <span class="toggle-slider"></span>
                      </label>
                      <input type="color" id="color-code-block" class="color-input" value="#A78BFA">
                    </div>
                  </div>

                  <div class="setting-item">
                    <div class="setting-left">
                      <span class="setting-icon">âœ…</span>
                      <span class="setting-name" data-i18n="lbl_status">æ“ä½œçŠ¶æ€</span>
                    </div>
                    <div class="setting-right">
                      <label class="toggle-switch">
                        <input type="checkbox" id="toggle-action-status">
                        <span class="toggle-slider"></span>
                      </label>
                      <input type="color" id="color-action-status" class="color-input" value="#4ADE80">
                    </div>
                  </div>

                  <div class="setting-item">
                    <div class="setting-left">
                      <span class="setting-icon">ğŸ’­</span>
                      <span class="setting-name" data-i18n="lbl_thinking">æ€è€ƒè¿‡ç¨‹</span>
                    </div>
                    <div class="setting-right">
                      <label class="toggle-switch">
                        <input type="checkbox" id="toggle-thinking">
                        <span class="toggle-slider"></span>
                      </label>
                      <input type="color" id="color-thinking" class="color-input" value="#9CA3AF">
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Tab: Features -->
        <div class="tab-content" id="tab-features">
          <!-- Accordion: Copy -->
          <div class="accordion-item expanded">
            <div class="accordion-header">
              <span class="accordion-title" data-i18n="copy_title">ğŸ“‹ ä¸€é”®å¤åˆ¶</span>
              <span class="accordion-icon">â–¼</span>
            </div>
            <div class="accordion-body">
              <div class="accordion-inner">
                <div class="main-toggle">
                  <span class="main-toggle-label" data-i18n="enable_copy">å¯ç”¨å¤åˆ¶æŒ‰é’®</span>
                  <label class="toggle-switch">
                    <input type="checkbox" id="copy-master-toggle">
                    <span class="toggle-slider"></span>
                  </label>
                </div>
                
                <div id="copy-settings">
                  <div class="setting-item">
                    <div class="setting-left">
                      <span class="setting-icon">ğŸ“</span>
                      <span class="setting-name" data-i18n="lbl_user_msg">ç”¨æˆ·æ¶ˆæ¯</span>
                    </div>
                    <div class="setting-right">
                      <label class="toggle-switch">
                        <input type="checkbox" id="toggle-copy-user" checked>
                        <span class="toggle-slider"></span>
                      </label>
                    </div>
                  </div>
                  <div class="setting-item">
                    <div class="setting-left">
                      <span class="setting-icon">ğŸ’­</span>
                      <span class="setting-name" data-i18n="lbl_thinking">æ€è€ƒè¿‡ç¨‹</span>
                    </div>
                    <div class="setting-right">
                      <label class="toggle-switch">
                        <input type="checkbox" id="toggle-copy-thinking" checked>
                        <span class="toggle-slider"></span>
                      </label>
                    </div>
                  </div>
                  <div class="setting-item">
                    <div class="setting-left">
                      <span class="setting-icon">ğŸ¤–</span>
                      <span class="setting-name" data-i18n="lbl_ai_resp">AIå›å¤</span>
                    </div>
                    <div class="setting-right">
                      <label class="toggle-switch">
                        <input type="checkbox" id="toggle-copy-ai" checked>
                        <span class="toggle-slider"></span>
                      </label>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <!-- Accordion: Hotkeys -->
          <div class="accordion-item">
            <div class="accordion-header">
              <span class="accordion-title" data-i18n="hotkey_title">âŒ¨ï¸ å¿«æ·é”®è®¾ç½®</span>
              <span class="accordion-icon">â–¼</span>
            </div>
            <div class="accordion-body">
              <div class="accordion-inner">
                <div class="main-toggle">
                  <span class="main-toggle-label" data-i18n="enable_hotkey">è‡ªå®šä¹‰å‘é€å¿«æ·é”®</span>
                  <label class="toggle-switch">
                    <input type="checkbox" id="hotkey-master-toggle">
                    <span class="toggle-slider"></span>
                  </label>
                </div>
                
                <div id="hotkey-settings">
                  <div class="setting-item">
                    <div class="setting-left">
                      <span class="setting-icon">â†µ</span>
                      <span class="setting-name" data-i18n="lbl_send_hotkey">å‘é€å¿«æ·é”®</span>
                    </div>
                    <div class="setting-right">
                      <select id="send-hotkey-select" class="select-input">
                        <option value="enter">Enter</option>
                        <option value="cmd+enter">âŒ˜ Cmd + Enter</option>
                        <option value="ctrl+enter">Ctrl + Enter</option>
                        <option value="shift+enter">â‡§ Shift + Enter</option>
                      </select>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <!-- Accordion: Auto Retry -->
          <div class="accordion-item">
            <div class="accordion-header">
              <span class="accordion-title" data-i18n="auto_retry_title">ğŸ”„ è‡ªåŠ¨é‡è¯•</span>
              <span class="accordion-icon">â–¼</span>
            </div>
            <div class="accordion-body">
              <div class="accordion-inner">
                <div class="main-toggle">
                  <span class="main-toggle-label" data-i18n="enable_auto_retry">å¯ç”¨è‡ªåŠ¨é‡è¯•</span>
                  <label class="toggle-switch">
                    <input type="checkbox" id="auto-retry-master-toggle">
                    <span class="toggle-slider"></span>
                  </label>
                </div>
                
                <div id="auto-retry-settings">
                  <div class="setting-item">
                    <div class="setting-left">
                      <span class="setting-icon">ğŸ”¢</span>
                      <span class="setting-name" data-i18n="lbl_retry_count">é‡è¯•æ¬¡æ•°</span>
                    </div>
                    <div class="setting-right">
                      <input type="number" id="retry-count-input" class="select-input" min="1" max="5" style="width: 60px; min-width: 60px;">
                    </div>
                  </div>
                  <div class="setting-item">
                    <div class="setting-left">
                      <span class="setting-icon">â±ï¸</span>
                      <span class="setting-name" data-i18n="lbl_retry_delay">å»¶è¿Ÿæ—¶é—´ (ç§’)</span>
                    </div>
                    <div class="setting-right">
                      <input type="number" id="retry-delay-input" class="select-input" min="1" max="10" style="width: 60px; min-width: 60px;">
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
  
  <script>
    /* ===== I18N å­—å…¸ ===== */
    const TRANSLATIONS = {
      zh: {
        tab_appearance: 'ğŸ¨ å¤–è§‚',
        tab_features: 'ğŸ› ï¸ åŠŸèƒ½',
        colors_title: 'ğŸ¨ é¢œè‰²è‡ªå®šä¹‰',
        enable_custom_colors: 'å¯ç”¨è‡ªå®šä¹‰é¢œè‰²',
        lbl_user_msg: 'ç”¨æˆ·æ¶ˆæ¯',
        lbl_ai_resp: 'AIå›å¤',
        lbl_code: 'ä»£ç å—',
        lbl_status: 'æ“ä½œçŠ¶æ€',
        lbl_thinking: 'æ€è€ƒè¿‡ç¨‹',
        copy_title: 'ğŸ“‹ ä¸€é”®å¤åˆ¶',
        enable_copy: 'å¯ç”¨å¤åˆ¶æŒ‰é’®',
        hotkey_title: 'âŒ¨ï¸ å¿«æ·é”®è®¾ç½®',
        enable_hotkey: 'è‡ªå®šä¹‰å‘é€å¿«æ·é”®',
        lbl_send_hotkey: 'å‘é€å¿«æ·é”®',
        auto_retry_title: 'ğŸ”„ è‡ªåŠ¨é‡è¯•',
        enable_auto_retry: 'å¯ç”¨è‡ªåŠ¨é‡è¯•',
        lbl_retry_count: 'é‡è¯•æ¬¡æ•°',
        lbl_retry_delay: 'å»¶è¿Ÿæ—¶é—´ (ç§’)',
        retry_toast_msg: 'æ­£åœ¨è‡ªåŠ¨é‡è¯• ({n}/{max})...',
        retry_toast_done: 'é‡è¯•è§¦å‘æˆåŠŸ'
      },
      en: {
        tab_appearance: 'ğŸ¨ Appearance',
        tab_features: 'ğŸ› ï¸ Features',
        colors_title: 'ğŸ¨ Colors',
        enable_custom_colors: 'Enable Custom Colors',
        lbl_user_msg: 'User Message',
        lbl_ai_resp: 'AI Response',
        lbl_code: 'Code Block',
        lbl_status: 'Action Status',
        lbl_thinking: 'Thinking Process',
        copy_title: 'ğŸ“‹ One-Click Copy',
        enable_copy: 'Enable Copy Buttons',
        hotkey_title: 'âŒ¨ï¸ Shortcuts',
        enable_hotkey: 'Custom Send Hotkey',
        lbl_send_hotkey: 'Send Hotkey',
        auto_retry_title: 'ğŸ”„ Auto Retry',
        enable_auto_retry: 'Enable Auto Retry',
        lbl_retry_count: 'Retry Count',
        lbl_retry_delay: 'Delay (s)',
        retry_toast_msg: 'Auto retrying ({n}/{max})...',
        retry_toast_done: 'Retry triggered'
      }
    };

    /* ===== æ—¢å­˜é…ç½®é€»è¾‘ ===== */
    const STORAGE_KEY = 'cascade-panel-settings';
    
    // é¢œè‰²é…ç½®
    const COLOR_CONFIGS = [
      { id: 'user-message', cssVar: '--color-user-message', cssClass: 'color-user-message', default: '#60A5FA', enabled: true },
      { id: 'ai-response', cssVar: '--color-ai-response', cssClass: 'color-ai-response', default: '#E0E0E0', enabled: true },
      { id: 'code-block', cssVar: '--color-code-block', cssClass: 'color-code-block', default: '#A78BFA', enabled: true },
      { id: 'action-status', cssVar: '--color-action-status', cssClass: 'color-action-status', default: '#4ADE80', enabled: false },
      { id: 'thinking', cssVar: '--color-thinking', cssClass: 'color-thinking', default: '#9CA3AF', enabled: false },
    ];

    // å¤åˆ¶é…ç½®
    const COPY_CONFIGS = [
      { id: 'copy-user', selector: '.bg-gray-500\\/15', textSelector: '.whitespace-pre-wrap', type: 'user' },
      { id: 'copy-thinking', selector: '.opacity-70.prose', textSelector: null, type: 'thinking' },
      { id: 'copy-ai', selector: '.prose:not(.opacity-70)', textSelector: null, type: 'ai' },
    ];

    // å¿«æ·é”®é€‰é¡¹
    const HOTKEY_OPTIONS = [
      { id: 'enter', label: 'Enter', check: (e) => e.key === 'Enter' && !e.metaKey && !e.ctrlKey && !e.shiftKey },
      { id: 'cmd+enter', label: 'âŒ˜ Cmd + Enter', check: (e) => e.key === 'Enter' && e.metaKey },
      { id: 'ctrl+enter', label: 'Ctrl + Enter', check: (e) => e.key === 'Enter' && e.ctrlKey },
      { id: 'shift+enter', label: 'â‡§ Shift + Enter', check: (e) => e.key === 'Enter' && e.shiftKey },
    ];

    const defaultSettings = {
      lang: 'zh',
      masterEnabled: false,
      colors: COLOR_CONFIGS.reduce((acc, c) => { acc[c.id] = { color: c.default, enabled: c.enabled }; return acc; }, {}),
      copyEnabled: false,
      copy: COPY_CONFIGS.reduce((acc, c) => { acc[c.id] = { enabled: true }; return acc; }, {}),
      hotkeyEnabled: false,
      sendHotkey: 'cmd+enter',
      autoRetryEnabled: false,
      retryCount: 1,
      retryDelay: 2
    };

    function loadSettings() {
      try {
        const saved = localStorage.getItem(STORAGE_KEY);
        if (saved) {
          const parsed = JSON.parse(saved);
          return {
            lang: parsed.lang ?? defaultSettings.lang,
            masterEnabled: parsed.masterEnabled ?? defaultSettings.masterEnabled,
            colors: { ...defaultSettings.colors, ...parsed.colors },
            copyEnabled: parsed.copyEnabled ?? defaultSettings.copyEnabled,
            copy: { ...defaultSettings.copy, ...parsed.copy },
            hotkeyEnabled: parsed.hotkeyEnabled ?? defaultSettings.hotkeyEnabled,
            sendHotkey: parsed.sendHotkey ?? defaultSettings.sendHotkey,
            autoRetryEnabled: parsed.autoRetryEnabled ?? defaultSettings.autoRetryEnabled,
            retryCount: parsed.retryCount ?? defaultSettings.retryCount,
            retryDelay: parsed.retryDelay ?? defaultSettings.retryDelay
          };
        }
        return defaultSettings;
      } catch (e) { return defaultSettings; }
    }

    function saveSettings(settings) {
      try { localStorage.setItem(STORAGE_KEY, JSON.stringify(settings)); } catch (e) { console.warn('Save failed:', e); }
    }

    /* ===== DOM å…ƒç´  ===== */
    const settingsBtn = document.getElementById('settings-toggle-btn');
    const overlay = document.getElementById('settings-overlay');
    const closeBtn = document.getElementById('modal-close-btn');
    const langSwitch = document.getElementById('lang-switch');
    const tabBtns = document.querySelectorAll('.tab-btn');
    const tabContents = document.querySelectorAll('.tab-content');
    const accordionHeaders = document.querySelectorAll('.accordion-header');
    
    // æ§ä»¶å¼•ç”¨
    const masterToggle = document.getElementById('master-toggle');
    const copyMasterToggle = document.getElementById('copy-master-toggle');
    const hotkeyMasterToggle = document.getElementById('hotkey-master-toggle');
    const autoRetryMasterToggle = document.getElementById('auto-retry-master-toggle');
    const retryCountInput = document.getElementById('retry-count-input');
    const retryDelayInput = document.getElementById('retry-delay-input');
    const retryToast = document.getElementById('retry-toast');
    const retryToastText = document.getElementById('retry-toast-text');
    const sendHotkeySelect = document.getElementById('send-hotkey-select');
    const reactApp = document.getElementById('react-app');

    /* ===== äº¤äº’é€»è¾‘ ===== */
    let currentSettings = loadSettings();

    // 1. è¯­è¨€åˆ‡æ¢
    function updateLanguage() {
      const lang = currentSettings.lang;
      const dict = TRANSLATIONS[lang];
      document.querySelectorAll('[data-i18n]').forEach(el => {
        const key = el.getAttribute('data-i18n');
        if (dict[key]) el.textContent = dict[key];
      });
      langSwitch.textContent = lang === 'zh' ? 'ğŸŒ English' : 'ğŸŒ ä¸­æ–‡';
    }

    langSwitch.addEventListener('click', () => {
      currentSettings.lang = currentSettings.lang === 'zh' ? 'en' : 'zh';
      saveSettings(currentSettings);
      updateLanguage();
    });

    // 2. Tab åˆ‡æ¢
    tabBtns.forEach(btn => {
      btn.addEventListener('click', () => {
        tabBtns.forEach(b => b.classList.remove('active'));
        tabContents.forEach(c => c.classList.remove('active'));
        
        btn.classList.add('active');
        const tabId = `tab-${btn.dataset.tab}`;
        document.getElementById(tabId).classList.add('active');
      });
    });

    // 3. æ‰‹é£ç´é€»è¾‘
    accordionHeaders.forEach(header => {
      header.addEventListener('click', () => {
        const item = header.parentElement;
        item.classList.toggle('expanded');
      });
    });

    // 4. å¼¹çª—æ§åˆ¶
    function openModal() {
      overlay.classList.add('show');
      requestAnimationFrame(() => overlay.classList.add('visible'));
    }
    function closeModal() {
      overlay.classList.remove('visible');
      setTimeout(() => overlay.classList.remove('show'), 300);
    }
    settingsBtn.addEventListener('click', openModal);
    closeBtn.addEventListener('click', closeModal);
    overlay.addEventListener('click', (e) => { if (e.target === overlay) closeModal(); });

    /* ===== åŠŸèƒ½å®ç° ===== */
    // A. é¢œè‰²åŠŸèƒ½
    function applyColorSettings() {
      COLOR_CONFIGS.forEach(config => {
        const colorSetting = currentSettings.colors[config.id];
        document.documentElement.style.setProperty(config.cssVar, colorSetting.color);
        if (currentSettings.masterEnabled && colorSetting.enabled) {
          reactApp.classList.add(config.cssClass);
        } else {
          reactApp.classList.remove(config.cssClass);
        }
      });
    }

    masterToggle.addEventListener('change', () => {
      currentSettings.masterEnabled = masterToggle.checked;
      saveSettings(currentSettings);
      applyColorSettings();
    });

    COLOR_CONFIGS.forEach(config => {
      const toggleEl = document.getElementById(`toggle-${config.id}`);
      const colorEl = document.getElementById(`color-${config.id}`);
      
      if (toggleEl) {
        toggleEl.addEventListener('change', () => {
          currentSettings.colors[config.id].enabled = toggleEl.checked;
          saveSettings(currentSettings);
          applyColorSettings();
        });
      }
      if (colorEl) {
        colorEl.addEventListener('input', () => {
          currentSettings.colors[config.id].color = colorEl.value;
          saveSettings(currentSettings);
          applyColorSettings();
        });
      }
    });

    // B. å¤åˆ¶åŠŸèƒ½
    let copyObserver = null;
    const COPY_ICON = '<svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M16 1H4c-1.1 0-2 .9-2 2v14h2V3h12V1zm3 4H8c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h11c1.1 0 2-.9 2-2V7c0-1.1-.9-2-2-2zm0 16H8V7h11v14z"/></svg>';
    const CHECK_ICON = '<svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41z"/></svg>';

    function copyToClipboard(text) {
      const textarea = document.createElement('textarea');
      textarea.value = text;
      textarea.style.position = 'fixed';
      textarea.style.left = '-9999px';
      document.body.appendChild(textarea);
      textarea.select();
      let success = false;
      try { success = document.execCommand('copy'); } catch (err) {}
      document.body.removeChild(textarea);
      return success;
    }

    function createCopyButton(targetEl, getText) {
      const btn = document.createElement('button');
      btn.className = 'copy-btn';
      btn.innerHTML = COPY_ICON;
      btn.addEventListener('click', (e) => {
        e.stopPropagation();
        e.preventDefault();
        const success = copyToClipboard(getText());
        if (success) {
          btn.innerHTML = CHECK_ICON;
          btn.classList.add('copied');
          setTimeout(() => {
            btn.innerHTML = COPY_ICON;
            btn.classList.remove('copied');
          }, 1500);
        }
      });
      return btn;
    }

    function injectCopyButtons() {
      if (!currentSettings.copyEnabled) return;
      COPY_CONFIGS.forEach(config => {
        if (!currentSettings.copy[config.id]?.enabled) return;
        const elements = reactApp.querySelectorAll(config.selector);
        elements.forEach(el => {
          if (el.querySelector('.copy-btn') || el.closest('#settings-overlay')) return;
          el.classList.add('copy-target');
          const getText = () => config.textSelector ? (el.querySelector(config.textSelector)?.textContent || el.textContent) : el.textContent;
          el.appendChild(createCopyButton(el, getText));
        });
      });
    }

    function removeCopyButtons() {
      reactApp.querySelectorAll('.copy-btn').forEach(btn => btn.remove());
      reactApp.querySelectorAll('.copy-target').forEach(el => el.classList.remove('copy-target'));
    }

    function applyCopySettings() {
      if (currentSettings.copyEnabled) {
        if (!copyObserver) {
          copyObserver = new MutationObserver(() => setTimeout(injectCopyButtons, 100));
          copyObserver.observe(reactApp, { childList: true, subtree: true });
          injectCopyButtons();
        }
      } else {
        if (copyObserver) { copyObserver.disconnect(); copyObserver = null; }
        removeCopyButtons();
      }
    }

    copyMasterToggle.addEventListener('change', () => {
      currentSettings.copyEnabled = copyMasterToggle.checked;
      saveSettings(currentSettings);
      applyCopySettings();
    });

    COPY_CONFIGS.forEach(config => {
      const toggleEl = document.getElementById(`toggle-${config.id}`);
      if (toggleEl) {
        toggleEl.addEventListener('change', () => {
          currentSettings.copy[config.id].enabled = toggleEl.checked;
          saveSettings(currentSettings);
          removeCopyButtons();
          if (currentSettings.copyEnabled) injectCopyButtons();
        });
      }
    });

    // C. å¿«æ·é”®åŠŸèƒ½
    let hotkeyHandler = null;
    const INPUT_SELECTOR = 'div[contenteditable="true"][data-lexical-editor="true"]';
    const SEND_BTN_SELECTOR = 'button[data-tooltip-id="input-send-button-send-tooltip"]';

    function createHotkeyHandler() {
      const selected = currentSettings.sendHotkey;
      const config = HOTKEY_OPTIONS.find(h => h.id === selected);
      return function(e) {
        const inputEl = e.target.closest(INPUT_SELECTOR);
        if (!inputEl || e.key !== 'Enter') return;
        
        // æ£€æŸ¥ä¸‹æ‹‰èœå•
        if (inputEl.hasAttribute('aria-activedescendant') || 
            (document.querySelector('.lexical-typeahead-menu') && document.querySelector('.lexical-typeahead-menu').style.display !== 'none')) {
          return;
        }

        if (config && config.check(e)) {
          e.preventDefault(); e.stopPropagation(); e.stopImmediatePropagation();
          const sendBtn = document.querySelector(SEND_BTN_SELECTOR);
          if (sendBtn) {
            // [æ–°å¢] ç‚¹å‡»å‘é€æ—¶é‡ç½®é‡è¯•è®¡æ•°
            currentRetryCount = 0;
            sendBtn.click();
          }
        } else if (e.key === 'Enter') {
          // é˜»æ­¢é»˜è®¤å‘é€ (é™¤éshift+enter)
          if (!e.shiftKey || selected === 'shift+enter') {
            e.stopPropagation(); e.stopImmediatePropagation();
          }
        }
      };
    }

    function applyHotkeySettings() {
      if (hotkeyHandler) { document.removeEventListener('keydown', hotkeyHandler, { capture: true }); hotkeyHandler = null; }
      if (currentSettings.hotkeyEnabled) {
        hotkeyHandler = createHotkeyHandler();
        document.addEventListener('keydown', hotkeyHandler, { capture: true });
      }
    }

    hotkeyMasterToggle.addEventListener('change', () => {
      currentSettings.hotkeyEnabled = hotkeyMasterToggle.checked;
      saveSettings(currentSettings);
      applyHotkeySettings();
    });

    sendHotkeySelect.addEventListener('change', () => {
      currentSettings.sendHotkey = sendHotkeySelect.value;
      saveSettings(currentSettings);
      if (currentSettings.hotkeyEnabled) applyHotkeySettings();
    });

    // D. è‡ªåŠ¨é‡è¯•åŠŸèƒ½
    let autoRetryObserver = null;
    let currentRetryCount = 0;
    let isRetrying = false;
    const ERROR_KEYWORDS = ['Agent terminated due to error', 'Try again', 'Try Again'];

    function showRetryToast(msg, isSuccess = false) {
      if (!retryToast) return;
      retryToastText.textContent = msg;
      retryToast.classList.add('show');
      if (isSuccess) retryToast.classList.add('success');
      else retryToast.classList.remove('success');
    }

    function hideRetryToast() {
      if (!retryToast) return;
      retryToast.classList.remove('show');
    }

    function handleAutoRetryLogic() {
      if (!currentSettings.autoRetryEnabled || isRetrying) return;
      
      // 1. ä½¿ç”¨ XPath é«˜æ•ˆæŸ¥æ‰¾é”™è¯¯å…³é”®è¯ï¼ˆé¿å…å…¨é‡ DOM æ‰«æï¼‰
      // æŸ¥æ‰¾åŒ…å« ERROR_KEYWORDS ä¸­ä»»æ„ä¸€ä¸ªçš„æ–‡æœ¬èŠ‚ç‚¹ï¼Œä¸”ä¸æ˜¯ script/style æ ‡ç­¾
      const keywordChecks = ERROR_KEYWORDS.map(k => `contains(text(), '${k}')`).join(' or ');
      const xpathSafe = `//*[not(self::script) and not(self::style) and (${keywordChecks})]`;
      
      let hasError = false;
      try {
        const result = document.evaluate(xpathSafe, reactApp, null, XPathResult.FIRST_ORDERED_NODE_TYPE, null);
        hasError = !!result.singleNodeValue;
      } catch (e) {}

      if (hasError) {
        // 2. æŸ¥æ‰¾é‡è¯•æŒ‰é’®
        const btnXpath = ".//button[contains(text(), 'Retry') or contains(text(), 'retry') or contains(text(), 'é‡è¯•')]";
        let retryBtn = null;
        try {
          const btnResult = document.evaluate(btnXpath, reactApp, null, XPathResult.FIRST_ORDERED_NODE_TYPE, null);
          retryBtn = btnResult.singleNodeValue;
        } catch (e) {}

        if (retryBtn && currentRetryCount < currentSettings.retryCount) {
          isRetrying = true;
          currentRetryCount++;
          
          const toastMsg = TRANSLATIONS[currentSettings.lang].retry_toast_msg
            .replace('{n}', currentRetryCount)
            .replace('{max}', currentSettings.retryCount);
          showRetryToast(toastMsg);
          
          setTimeout(() => {
            // å®‰å…¨æ£€æŸ¥ï¼šç‚¹å‡»å‰ç¡®è®¤æŒ‰é’®ä»ç„¶å­˜åœ¨ä¸”è¿æ¥åœ¨ DOM ä¸­
            if (retryBtn && retryBtn.isConnected) {
              retryBtn.click();
              showRetryToast(TRANSLATIONS[currentSettings.lang].retry_toast_done, true);
            } else {
              hideRetryToast(); // æŒ‰é’®æ¶ˆå¤±äº†ï¼Œå–æ¶ˆæç¤º
            }
            
            setTimeout(() => {
              isRetrying = false;
              hideRetryToast();
            }, 1500);
          }, currentSettings.retryDelay * 1000);
        }
      } else {
        // 3. æˆåŠŸæ£€æµ‹ä¼˜åŒ–ï¼šå¦‚æœä¹‹å‰æœ‰é”™è¯¯ï¼Œä¸”ç°åœ¨æ£€æµ‹åˆ° AI å›å¤ï¼Œåˆ™é‡ç½®
        if (currentRetryCount > 0 && !isRetrying) {
          const hasAIPrompt = reactApp.querySelector('.prose:not(.opacity-70)');
          if (hasAIPrompt) {
            currentRetryCount = 0;
          }
        }
      }
    }

    // é‡ç½®é‡è¯•è®¡æ•°çš„ç®€å•å¯å‘å¼ï¼šå½“è¾“å…¥æ¡†è·å¾—ç„¦ç‚¹æˆ–å†…å®¹å˜åŒ–æ—¶
    reactApp.addEventListener('input', (e) => {
      if (e.target.closest(INPUT_SELECTOR)) {
        if (currentRetryCount > 0) {
          currentRetryCount = 0;
        }
      }
    });

    function applyAutoRetrySettings() {
      if (autoRetryObserver) { autoRetryObserver.disconnect(); autoRetryObserver = null; }
      if (currentSettings.autoRetryEnabled) {
        autoRetryObserver = new MutationObserver(() => {
          clearTimeout(window.retryThrottleTimer);
          window.retryThrottleTimer = setTimeout(handleAutoRetryLogic, 500);
        });
        autoRetryObserver.observe(reactApp, { childList: true, subtree: true });
        handleAutoRetryLogic();
      }
    }

    autoRetryMasterToggle.addEventListener('change', () => {
      currentSettings.autoRetryEnabled = autoRetryMasterToggle.checked;
      saveSettings(currentSettings);
      applyAutoRetrySettings();
    });

    retryCountInput.addEventListener('change', () => {
      currentSettings.retryCount = parseInt(retryCountInput.value) || 1;
      saveSettings(currentSettings);
    });

    retryDelayInput.addEventListener('change', () => {
      currentSettings.retryDelay = parseInt(retryDelayInput.value) || 2;
      saveSettings(currentSettings);
    });

    /* ===== åˆå§‹åŒ– ===== */
    function initUI() {
      // 1. è®¾ç½®æ§ä»¶çŠ¶æ€
      masterToggle.checked = currentSettings.masterEnabled;
      copyMasterToggle.checked = currentSettings.copyEnabled;
      hotkeyMasterToggle.checked = currentSettings.hotkeyEnabled;
      sendHotkeySelect.value = currentSettings.sendHotkey;

      COLOR_CONFIGS.forEach(c => {
        const t = document.getElementById(`toggle-${c.id}`);
        const col = document.getElementById(`color-${c.id}`);
        if (t) t.checked = currentSettings.colors[c.id].enabled;
        if (col) col.value = currentSettings.colors[c.id].color;
      });

      COPY_CONFIGS.forEach(c => {
        const t = document.getElementById(`toggle-${c.id}`);
        if (t) t.checked = currentSettings.copy[c.id]?.enabled ?? true;
      });

      autoRetryMasterToggle.checked = currentSettings.autoRetryEnabled;
      retryCountInput.value = currentSettings.retryCount;
      retryDelayInput.value = currentSettings.retryDelay;

      // 2. åº”ç”¨åŠŸèƒ½
      applyColorSettings();
      applyCopySettings();
      applyHotkeySettings();
      applyAutoRetrySettings();
      updateLanguage();
    }

    if (document.readyState !== 'loading') initUI();
    else document.addEventListener('DOMContentLoaded', initUI);
  </script>
</body>
</html>
