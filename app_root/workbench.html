<!-- Copyright (C) Microsoft Corporation. All rights reserved. -->
<!DOCTYPE html>
<html>

<head>
	<meta charset="utf-8" />
	<meta http-equiv="Content-Security-Policy" content="
				default-src
					'none'
				;
				img-src
					'self'
					data:
					blob:
					vscode-remote-resource:
					vscode-managed-remote-resource:
					https:
				;
				media-src
					'self'
					data:
					https://127.0.0.1:*
					blob:
					https://www.gstatic.com/
				;
				frame-src
					'self'
					vscode-webview:
					data:
				;
				script-src
					'self'
					'unsafe-eval'
					'unsafe-inline'
					blob:
				;
				style-src
					'self'
					'unsafe-inline'
				;
				connect-src
					'self'
					data:
					http://127.0.0.1:*
					http://jetski-unleash.corp.goog/
					http://antigravity-unleash.goog/
					https:
					ws:
				;
				font-src
					'self'
					vscode-remote-resource:
					vscode-managed-remote-resource:
					https://*.vscode-unpkg.net
				;
				require-trusted-types-for
					'script'
				;
				trusted-types
					amdLoader
					cellRendererEditorText
					collapsedCellPreview
					defaultWorkerFactory
					diffEditorWidget
					diffReview
					domLineBreaksComputer
					dompurify
					dompurifyMermaid
					editorGhostText
					editorViewLayer
					mermaid
					notebookRenderer
					stickyScrollViewLayer
					tokenizeToString
					notebookChatEditController
					richScreenReaderContent
					renderCodeBlock
					antigravityBetter
				;
		" />

	<!-- Workbench CSS -->
	<link rel="stylesheet" href="../../../workbench/workbench.desktop.main.css">

	<style>
		/* ===== Antigravity Better v0.2.1 ===== */
		:root {
			--color-user-message: #60A5FA;
			--color-ai-response: #E0E0E0;
			--color-code-block: #A78BFA;
			--color-action-status: #4ADE80;
			--color-thinking: #9CA3AF;
			--fontsize-user-message: 14px;
			--fontsize-ai-response: 14px;
			--fontsize-code-block: 13px;
			--fontsize-action-status: 13px;
			--fontsize-thinking: 13px;
			--bg-modal: #1e1e1e;
			--border-color: #3c3c3c;
			--accent-color: #667eea;
			--text-main: #fff;
			--text-sub: #999;
		}

		/* ÊÇ¨ÊµÆÊåâÈíÆ (absolute in side-panel) */
		#ab-settings-btn { position:absolute; right:0; top:66%; transform:translateY(-50%); width:28px; height:48px; background:linear-gradient(135deg,#667eea,#764ba2); border:none; border-radius:8px 0 0 8px; cursor:pointer; display:flex; align-items:center; justify-content:center; box-shadow:-2px 2px 8px rgba(0,0,0,.3); z-index:9999; transition:all .3s ease; }
		#ab-settings-btn:hover { width:36px; background:linear-gradient(135deg,#764ba2,#667eea); }
		#ab-settings-btn svg { width:18px; height:18px; fill:#fff; transition:transform .3s ease; }
		#ab-settings-btn:hover svg { transform:rotate(90deg); }

		/* ÈÅÆÁΩ©Â±Ç (absolute in side-panel) */
		#ab-overlay { position:absolute; top:0;left:0;right:0;bottom:0; background:rgba(0,0,0,.5); z-index:10000; display:none; opacity:0; transition:opacity .3s ease; align-items:center; justify-content:center; }
		#ab-overlay.show { display:flex; }
		#ab-overlay.visible { opacity:1; }

		/* ÂºπÁ™ó */
		#ab-modal { background:var(--bg-modal); border-radius:12px; width:400px; max-width:90%; max-height:85%; display:flex; flex-direction:column; box-shadow:0 8px 32px rgba(0,0,0,.4); border:1px solid var(--border-color); transform:scale(.9); transition:transform .3s cubic-bezier(.34,1.56,.64,1); overflow:hidden; }
		#ab-overlay.visible #ab-modal { transform:scale(1); }

		/* Header */
		.ab-header { padding:16px 20px; border-bottom:1px solid var(--border-color); display:flex; justify-content:space-between; align-items:flex-start; background:rgba(255,255,255,.02); }
		.ab-header-left { display:flex; flex-direction:column; }
		.ab-brand { color:var(--text-main); font-size:16px; font-weight:700; background:linear-gradient(90deg,#fff,#a5b4fc); -webkit-background-clip:text; background-clip:text; -webkit-text-fill-color:transparent; }
		.ab-version { font-size:10px; color:var(--text-sub); background:rgba(255,255,255,.1); padding:2px 6px; border-radius:4px; margin-left:8px; font-weight:normal; -webkit-text-fill-color:var(--text-sub); }
		.ab-brand-links { display:flex; gap:12px; margin-top:4px; }
		.ab-brand-link { color:var(--text-sub); font-size:10px; text-decoration:none; transition:color .2s; }
		.ab-brand-link:hover { color:var(--accent-color); }
		.ab-header-right { display:flex; align-items:center; gap:12px; }
		.ab-lang-switch { background:none; border:1px solid var(--border-color); color:var(--text-sub); font-size:11px; padding:4px 8px; border-radius:4px; cursor:pointer; transition:all .2s; }
		.ab-lang-switch:hover { border-color:var(--text-main); color:var(--text-main); }
		.ab-close { background:none; border:none; color:var(--text-sub); font-size:20px; cursor:pointer; padding:0; line-height:1; transition:color .2s; }
		.ab-close:hover { color:var(--text-main); }

		/* Tab ÂØºËà™ */
		.ab-tab-nav { display:flex; border-bottom:1px solid var(--border-color); padding:0 10px; background:rgba(0,0,0,.1); }
		.ab-tab-btn { flex:1; background:none; border:none; color:var(--text-sub); padding:12px 12px; min-height:42px; font-size:13px; cursor:pointer; position:relative; transition:all .2s; box-sizing:border-box; outline:none; }
		.ab-tab-btn:hover { color:var(--text-main); }
		.ab-tab-btn.active { color:var(--accent-color); font-weight:600; }
		.ab-tab-btn.active::after { content:''; position:absolute; bottom:-1px; left:0; width:100%; height:2px; background:var(--accent-color); }

		/* Tab ÂÜÖÂÆπ */
		.ab-body { flex:1; overflow-y:auto; padding:0; }
		.ab-tab-content { display:none; animation:abFadeIn .2s ease; }
		.ab-tab-content.active { display:block; }
		@keyframes abFadeIn { from{opacity:0;transform:translateY(5px)} to{opacity:1;transform:translateY(0)} }

		/* ÊâãÈ£éÁê¥ */
		.ab-accordion { border-bottom:1px solid var(--border-color); }
		.ab-accordion-header { padding:14px 20px; background:rgba(255,255,255,.01); cursor:pointer; display:flex; justify-content:space-between; align-items:center; transition:background .2s; }
		.ab-accordion-header:hover { background:rgba(255,255,255,.03); }
		.ab-accordion-title { font-size:13px; font-weight:600; color:var(--text-main); display:flex; align-items:center; gap:8px; }
		.ab-accordion-icon { font-size:10px; color:var(--text-sub); transition:transform .3s; }
		.ab-accordion.expanded .ab-accordion-icon { transform:rotate(180deg); }
		.ab-accordion-body { max-height:0; overflow:hidden; transition:max-height .3s cubic-bezier(0,1,0,1); background:rgba(0,0,0,.1); }
		.ab-accordion.expanded .ab-accordion-body { max-height:1000px; transition:max-height .3s ease-in-out; }
		.ab-accordion-inner { padding:16px 20px; }

		/* ÈÄöÁî®Êéß‰ª∂ */
		.ab-main-toggle { display:flex; align-items:center; justify-content:space-between; padding:10px 12px; background:rgba(102,126,234,.1); border:1px solid rgba(102,126,234,.2); border-radius:8px; margin-bottom:12px; }
		.ab-main-toggle-label { color:var(--text-main); font-size:13px; font-weight:500; }
		.ab-setting { display:flex; align-items:center; justify-content:space-between; padding:8px 0; border-bottom:1px solid rgba(255,255,255,.05); }
		.ab-setting:last-child { border-bottom:none; }
		.ab-setting-left { display:flex; align-items:center; gap:10px; }
		.ab-setting-icon { font-size:15px; width:20px; text-align:center; color:var(--text-sub); line-height:28px; }
		.ab-setting-name { color:#ccc; font-size:13px; line-height:28px; }
		.ab-setting-right { display:flex; align-items:center; gap:8px; }
		.ab-setting-desc { font-size:11px; color:var(--text-sub); margin-bottom:12px; line-height:1.5; }

		/* Toggle Switch */
		.ab-toggle { position:relative; display:inline-block; width:32px; height:18px; flex-shrink:0; }
		.ab-toggle input { display:none !important; }
		.ab-toggle-slider { position:absolute; cursor:pointer; top:0;left:0;right:0;bottom:0; background-color:#3c3c3c; transition:.3s; border-radius:20px; }
		.ab-toggle-slider:before { position:absolute; content:""; height:12px; width:12px; left:3px; bottom:3px; background-color:#fff; transition:.3s; border-radius:50%; }
		.ab-toggle input:checked+.ab-toggle-slider { background:var(--accent-color); }
		.ab-toggle input:checked+.ab-toggle-slider:before { transform:translateX(14px); }

		/* Color/Select/FontSize Input */
		.ab-color-input { width:24px; height:24px; border:1px solid var(--border-color); border-radius:4px; cursor:pointer; padding:0; background:none; }
		.ab-color-input::-webkit-color-swatch-wrapper { padding:2px; }
		.ab-color-input::-webkit-color-swatch { border-radius:2px; border:none; }
		.ab-select-input { background:#2d2d2d !important; border:1px solid var(--border-color) !important; border-radius:6px !important; padding:0 8px !important; color:#ccc !important; font-size:12px !important; cursor:pointer; outline:none !important; min-width:110px; height:28px !important; line-height:28px !important; box-sizing:border-box; -webkit-appearance:menulist; appearance:menulist; }
		.ab-select-input:focus { border-color:var(--accent-color) !important; outline:none !important; }
		.ab-select-input option { background:#2d2d2d; color:#ccc; }
		.ab-fontsize-input { width:60px !important; background:#2d2d2d !important; border:1px solid var(--border-color) !important; border-radius:6px !important; padding:2px 4px !important; color:#ccc !important; font-size:12px !important; text-align:center; outline:none !important; height:28px !important; box-sizing:border-box; }
		.ab-fontsize-input:focus { border-color:var(--accent-color) !important; outline:none !important; }
		.ab-fontsize-input::-webkit-inner-spin-button { opacity:0; height:24px; cursor:pointer; transition:opacity .2s; }
		.ab-fontsize-input:focus::-webkit-inner-spin-button { opacity:1; }

		/* ÊåâÈíÆÁªÑ */
		.ab-btn-group { display:flex; gap:10px; margin-top:10px; }
		.ab-btn { flex:1; padding:8px; border-radius:6px; border:none; cursor:pointer; font-size:12px; transition:all .2s; }
		.ab-btn.primary { background:var(--accent-color); color:#fff; }
		.ab-btn.primary:hover { filter:brightness(1.1); }
		.ab-btn.secondary { background:rgba(255,255,255,.1); color:#ccc; border:1px solid var(--border-color); }
		.ab-btn.secondary:hover { background:rgba(255,255,255,.15); }
		.ab-save-status { font-size:11px; text-align:center; margin-top:8px; min-height:16px; color:#4ADE80; }

		/* ÂêåÊ≠•ÊåâÈíÆ */
		.ab-sync-btn { background:rgba(102,126,234,.2); border:1px solid rgba(102,126,234,.3); color:var(--accent-color); font-size:11px; padding:3px 8px; border-radius:4px; cursor:pointer; transition:all .2s; white-space:nowrap; }
		.ab-sync-btn:hover { background:rgba(102,126,234,.4); }

		/* Pattern Grid (Auto Accept) */
		.ab-pattern-grid { display:flex; flex-wrap:wrap; gap:8px; margin:12px 0; }
		.ab-pattern-item { display:flex; align-items:center; gap:6px; padding:6px 10px; background:rgba(0,0,0,.3); border:1px solid var(--border-color); border-radius:6px; cursor:pointer; transition:all .2s; font-size:12px; color:#ccc; }
		.ab-pattern-item:hover { background:rgba(255,255,255,.05); }
		.ab-pattern-item.active { border-color:var(--accent-color); background:rgba(102,126,234,.15); color:var(--text-main); }
		.ab-pattern-item input[type="checkbox"] { accent-color:var(--accent-color); width:14px; height:14px; cursor:pointer; outline:none !important; box-shadow:none !important; border:none !important; }

		/* ÁªüËÆ°Èù¢Êùø */
		.ab-stats-panel { display:flex; justify-content:space-around; padding:12px; background:rgba(0,0,0,.2); border-radius:8px; margin-top:12px; }
		.ab-stat-item { text-align:center; flex:1; }
		.ab-stat-icon { font-size:16px; display:block; margin-bottom:4px; }
		.ab-stat-value { display:block; font-size:18px; font-weight:700; color:var(--text-main); }
		.ab-stat-label { font-size:10px; color:var(--text-sub); text-transform:uppercase; }

		/* Textarea */
		.ab-textarea { width:100% !important; min-height:100px; background:rgba(0,0,0,.3) !important; border:1px solid var(--border-color) !important; border-radius:6px !important; color:#ccc !important; font-family:'Consolas','Monaco',monospace; font-size:11px !important; padding:10px !important; resize:vertical; outline:none !important; box-sizing:border-box; }
		.ab-textarea:focus { border-color:var(--accent-color) !important; outline:none !important; }

		/* Toast */
		#ab-toast { position:absolute; top:10px; left:50%; transform:translateX(-50%); background:rgba(0,0,0,.85); color:#fff; padding:10px 20px; border-radius:20px; font-size:13px; z-index:20000; display:none; opacity:0; transition:opacity .3s ease,top .3s ease; box-shadow:0 4px 12px rgba(0,0,0,.3); border:1px solid rgba(255,255,255,.1); }
		#ab-toast.show { display:block; opacity:1; top:20px; }

		/* ===== È¢úËâ≤Ë¶ÜÁõñ (V0.2 ÈÄâÊã©Âô®) ===== */
		body.color-user-message .antigravity-agent-side-panel .bg-gray-500\/15 .whitespace-pre-wrap,
		body.color-user-message .antigravity-agent-side-panel .bg-gray-500\/15 [style*="word-break"] { color:var(--color-user-message) !important; }

		body.color-ai-response .antigravity-agent-side-panel .leading-relaxed.select-text:not(.opacity-70) p,
		body.color-ai-response .antigravity-agent-side-panel .leading-relaxed.select-text:not(.opacity-70) li,
		body.color-ai-response .antigravity-agent-side-panel .leading-relaxed.select-text:not(.opacity-70) h1,
		body.color-ai-response .antigravity-agent-side-panel .leading-relaxed.select-text:not(.opacity-70) h2,
		body.color-ai-response .antigravity-agent-side-panel .leading-relaxed.select-text:not(.opacity-70) h3,
		body.color-ai-response .antigravity-agent-side-panel .leading-relaxed.select-text:not(.opacity-70) h4,
		body.color-ai-response .antigravity-agent-side-panel .leading-relaxed.select-text:not(.opacity-70) strong,
		body.color-ai-response .antigravity-agent-side-panel .leading-relaxed.select-text:not(.opacity-70) ul,
		body.color-ai-response .antigravity-agent-side-panel .leading-relaxed.select-text:not(.opacity-70) ol,
		body.color-ai-response .antigravity-agent-side-panel .leading-relaxed.select-text:not(.opacity-70) table,
		body.color-ai-response .antigravity-agent-side-panel .leading-relaxed.select-text:not(.opacity-70) th,
		body.color-ai-response .antigravity-agent-side-panel .leading-relaxed.select-text:not(.opacity-70) td { color:var(--color-ai-response) !important; }

		body.color-code-block .antigravity-agent-side-panel .leading-relaxed pre,
		body.color-code-block .antigravity-agent-side-panel .leading-relaxed pre code,
		body.color-code-block .antigravity-agent-side-panel .leading-relaxed pre span,
		body.color-code-block .antigravity-agent-side-panel .leading-relaxed code.whitespace-pre-wrap { color:var(--color-code-block) !important; }

		body.color-thinking .antigravity-agent-side-panel .leading-relaxed.select-text.opacity-70,
		body.color-thinking .antigravity-agent-side-panel .leading-relaxed.select-text.opacity-70 * { color:var(--color-thinking) !important; }

		/* ===== Â≠ó‰ΩìÂ§ßÂ∞èË¶ÜÁõñ (V0.2 ÈÄâÊã©Âô®) ===== */
		body.fontsize-user-message .antigravity-agent-side-panel .bg-gray-500\/15 .whitespace-pre-wrap,
		body.fontsize-user-message .antigravity-agent-side-panel .bg-gray-500\/15 [style*="word-break"] { font-size:var(--fontsize-user-message) !important; }

		body.fontsize-ai-response .antigravity-agent-side-panel .leading-relaxed.select-text:not(.opacity-70) p,
		body.fontsize-ai-response .antigravity-agent-side-panel .leading-relaxed.select-text:not(.opacity-70) li,
		body.fontsize-ai-response .antigravity-agent-side-panel .leading-relaxed.select-text:not(.opacity-70) h2,
		body.fontsize-ai-response .antigravity-agent-side-panel .leading-relaxed.select-text:not(.opacity-70) h3,
		body.fontsize-ai-response .antigravity-agent-side-panel .leading-relaxed.select-text:not(.opacity-70) strong,
		body.fontsize-ai-response .antigravity-agent-side-panel .leading-relaxed.select-text:not(.opacity-70) ul,
		body.fontsize-ai-response .antigravity-agent-side-panel .leading-relaxed.select-text:not(.opacity-70) ol,
		body.fontsize-ai-response .antigravity-agent-side-panel .leading-relaxed.select-text:not(.opacity-70) table,
		body.fontsize-ai-response .antigravity-agent-side-panel .leading-relaxed.select-text:not(.opacity-70) th,
		body.fontsize-ai-response .antigravity-agent-side-panel .leading-relaxed.select-text:not(.opacity-70) td { font-size:var(--fontsize-ai-response) !important; }

		body.fontsize-code-block .antigravity-agent-side-panel .leading-relaxed pre,
		body.fontsize-code-block .antigravity-agent-side-panel .leading-relaxed pre code,
		body.fontsize-code-block .antigravity-agent-side-panel .leading-relaxed pre span { font-size:var(--fontsize-code-block) !important; }

		body.fontsize-thinking .antigravity-agent-side-panel .leading-relaxed.select-text.opacity-70,
		body.fontsize-thinking .antigravity-agent-side-panel .leading-relaxed.select-text.opacity-70 * { font-size:var(--fontsize-thinking) !important; }

		/* ===== Â§çÂà∂ÊåâÈíÆ ===== */
		.copy-btn { position:absolute; top:6px; right:26px; width:26px; height:26px; background:rgba(60,60,60,.9); border:1px solid rgba(255,255,255,.1); border-radius:5px; cursor:pointer; display:flex; align-items:center; justify-content:center; opacity:0; transition:all .2s ease; z-index:10; }
		.copy-btn svg { width:14px; height:14px; fill:#ccc; }
		.copy-btn:hover { background:rgba(102,126,234,.8); border-color:rgba(102,126,234,.5); }
		.copy-btn:hover svg { fill:#fff; }
		.copy-btn.copied { background:rgba(74,222,128,.8); }
		.copy-btn.copied svg { fill:#fff; }
		.copy-target { position:relative; }
		.copy-target:hover .copy-btn { opacity:1; }

		/* ===== LaTeX ÂÖ¨Âºè ===== */
		.latex-block { display:block; text-align:center; margin:1em 0; overflow-x:auto; }
		.latex-error { color:#f87171; font-size:12px; background:rgba(248,113,113,.1); padding:2px 6px; border-radius:3px; font-family:monospace; }
		.latex-code-rendered { padding:16px; text-align:center; overflow-x:auto; }
		.latex-code-rendered .katex { font-size:1.1em; }
	</style>
</head>

<body aria-label="">



</body>

<!-- Startup (do not modify order of script tags!) -->
<script src="./workbench.js" type="module"></script>
<script>
(function () {
	'use strict';
	/* ===== Antigravity Better v0.2.1 ===== */
	console.log('[AB] Antigravity Better v0.2.1 Loading...');

	// ===== Trusted Types Policy =====
	let abPolicy = null;
	if (window.trustedTypes && trustedTypes.createPolicy) {
		try {
			abPolicy = trustedTypes.createPolicy('antigravityBetter', { createHTML: (input) => input, createScriptURL: (input) => input });
			console.log('[AB] ‚úÖ Trusted Types Policy ÂàõÂª∫ÊàêÂäü');
		} catch (e) { console.warn('[AB] ‚ö†Ô∏è Trusted Types Policy ÂàõÂª∫Â§±Ë¥•:', e.message); }
	}
	function safeSetHTML(el, html) { el.innerHTML = abPolicy ? abPolicy.createHTML(html) : html; }

	// ===== I18N Â≠óÂÖ∏ =====
	const T = {
		zh: {
			tab_appearance: 'üé® Â§ñËßÇ', tab_features: 'üõ†Ô∏è ÂäüËÉΩ', tab_system: '‚öôÔ∏è Á≥ªÁªü',
			colors_title: 'üé® È¢úËâ≤Ëá™ÂÆö‰πâ', enable_custom_colors: 'ÂêØÁî®Ëá™ÂÆö‰πâÈ¢úËâ≤',
			lbl_user_msg: 'Áî®Êà∑Ê∂àÊÅØ', lbl_ai_resp: 'AIÂõûÂ§ç', lbl_code: '‰ª£Á†ÅÂùó', lbl_status: 'Êìç‰ΩúÁä∂ÊÄÅ', lbl_thinking: 'ÊÄùËÄÉËøáÁ®ã',
			fontsize_title: 'üî§ Â≠ó‰ΩìÂ§ßÂ∞è', enable_custom_fontsize: 'ÂêØÁî®Ëá™ÂÆö‰πâÂ≠ó‰ΩìÂ§ßÂ∞è', btn_sync: 'ÂêåÊ≠•ÂÖ®ÈÉ®',
			copy_title: 'üìã ‰∏ÄÈîÆÂ§çÂà∂', enable_copy: 'ÂêØÁî®Â§çÂà∂ÊåâÈíÆ',
			hotkey_title: '‚å®Ô∏è Âø´Êç∑ÈîÆËÆæÁΩÆ', enable_hotkey: 'Ëá™ÂÆö‰πâÂèëÈÄÅÂø´Êç∑ÈîÆ', lbl_send_hotkey: 'ÂèëÈÄÅÂø´Êç∑ÈîÆ',
			auto_accept_title: 'ü§ñ Ëá™Âä®Êìç‰Ωú', enable_auto_accept: 'ÂêØÁî®Ëá™Âä®Êìç‰Ωú', auto_accept_desc: 'ÈÄâÊã©Ë¶ÅËá™Âä®ÁÇπÂáªÁöÑÊåâÈíÆÁ±ªÂûã',
			stat_clicks: 'Â∑≤ÁÇπÂáª', stat_blocked: 'Â∑≤ÈòªÊ≠¢', stat_verified: 'Â∑≤È™åËØÅ',
			banned_title: 'üõ°Ô∏è ÂÆâÂÖ®ËßÑÂàô', banned_desc: 'ÂåÖÂê´‰ª•‰∏ãÂÖ≥ÈîÆËØçÁöÑÂëΩ‰ª§Â∞Ü‰∏ç‰ºöË¢´Ëá™Âä®ÊâßË°åÔºàÊØèË°å‰∏Ä‰∏™Ôºâ',
			btn_save: '‰øùÂ≠ò', btn_reset: 'ÈáçÁΩÆ', banned_saved: '‚úì ÂÆâÂÖ®ËßÑÂàôÂ∑≤‰øùÂ≠ò', banned_reset: '‚úì Â∑≤ÈáçÁΩÆ‰∏∫ÈªòËÆ§ÂÄº',
			version_title: 'üîÑ ÁâàÊú¨Êõ¥Êñ∞', lbl_auto_update: 'ÂêØÂä®Êó∂Ëá™Âä®Ê£ÄÊµã', lbl_manual_update: 'ÊâãÂä®Ê£ÄÊµãÊõ¥Êñ∞', btn_check_update: 'Á´ãÂç≥Ê£ÄÊµã',
			update_checking: 'Ê≠£Âú®Ê£ÄÊµã...', update_latest: '‚úì Â∑≤ÊòØÊúÄÊñ∞ÁâàÊú¨', update_found: '‚úì ÂèëÁé∞Êñ∞ÁâàÊú¨', update_failed: '‚úó Ê£ÄÊµãÂ§±Ë¥•',
			update_available: 'Êñ∞ÁâàÊú¨ÂèØÁî®', btn_download: '‰∏ãËΩΩÊõ¥Êñ∞',
			latex_title: 'üìê LaTeX ÂÖ¨Âºè', enable_latex: 'ÂêØÁî® LaTeX Ê∏≤Êüì', latex_desc: 'Ëá™Âä®Ê∏≤Êüì AI ÂõûÂ§ç‰∏≠ÁöÑ LaTeX Êï∞Â≠¶ÂÖ¨Âºè'
		},
		en: {
			tab_appearance: 'üé® Appearance', tab_features: 'üõ†Ô∏è Features', tab_system: '‚öôÔ∏è System',
			colors_title: 'üé® Colors', enable_custom_colors: 'Enable Custom Colors',
			lbl_user_msg: 'User Message', lbl_ai_resp: 'AI Response', lbl_code: 'Code Block', lbl_status: 'Action Status', lbl_thinking: 'Thinking Process',
			fontsize_title: 'üî§ Font Size', enable_custom_fontsize: 'Enable Custom Font Size', btn_sync: 'Sync All',
			copy_title: 'üìã One-Click Copy', enable_copy: 'Enable Copy Buttons',
			hotkey_title: '‚å®Ô∏è Shortcuts', enable_hotkey: 'Custom Send Hotkey', lbl_send_hotkey: 'Send Hotkey',
			auto_accept_title: 'ü§ñ Auto Accept', enable_auto_accept: 'Enable Auto Accept', auto_accept_desc: 'Select button types to auto-click',
			stat_clicks: 'Clicked', stat_blocked: 'Blocked', stat_verified: 'Verified',
			banned_title: 'üõ°Ô∏è Safety Rules', banned_desc: 'Commands containing these keywords will not be auto-executed (one per line)',
			btn_save: 'Save', btn_reset: 'Reset', banned_saved: '‚úì Safety rules saved', banned_reset: '‚úì Reset to defaults',
			version_title: 'üîÑ Version Update', lbl_auto_update: 'Auto check on startup', lbl_manual_update: 'Manual check', btn_check_update: 'Check Now',
			update_checking: 'Checking...', update_latest: '‚úì Already latest', update_found: '‚úì New version found', update_failed: '‚úó Check failed',
			update_available: 'New version available', btn_download: 'Download',
			latex_title: 'üìê LaTeX Formulas', enable_latex: 'Enable LaTeX Rendering', latex_desc: 'Auto-render LaTeX math formulas in AI responses'
		}
	};
	function t(key) { return (T[currentSettings.lang] || T.zh)[key] || key; }

	// ===== ÈÖçÁΩÆ =====
	const APP_VERSION = '0.2.1';
	const STORAGE_KEY = 'antigravity-better-settings';

	const COLOR_CONFIGS = [
		{ id: 'user-message', cssVar: '--color-user-message', cssClass: 'color-user-message', default: '#60A5FA', enabled: true, icon: 'üìù' },
		{ id: 'ai-response', cssVar: '--color-ai-response', cssClass: 'color-ai-response', default: '#E0E0E0', enabled: true, icon: 'ü§ñ' },
		{ id: 'code-block', cssVar: '--color-code-block', cssClass: 'color-code-block', default: '#A78BFA', enabled: true, icon: 'üíª' },
		{ id: 'action-status', cssVar: '--color-action-status', cssClass: 'color-action-status', default: '#4ADE80', enabled: false, icon: '‚úÖ' },
		{ id: 'thinking', cssVar: '--color-thinking', cssClass: 'color-thinking', default: '#9CA3AF', enabled: false, icon: 'üí≠' },
	];

	const FONTSIZE_CONFIGS = [
		{ id: 'user-message', cssVar: '--fontsize-user-message', cssClass: 'fontsize-user-message', default: 14, enabled: true, icon: 'üìù' },
		{ id: 'ai-response', cssVar: '--fontsize-ai-response', cssClass: 'fontsize-ai-response', default: 14, enabled: true, icon: 'ü§ñ' },
		{ id: 'code-block', cssVar: '--fontsize-code-block', cssClass: 'fontsize-code-block', default: 13, enabled: true, icon: 'üíª' },
		{ id: 'action-status', cssVar: '--fontsize-action-status', cssClass: 'fontsize-action-status', default: 13, enabled: false, icon: '‚úÖ' },
		{ id: 'thinking', cssVar: '--fontsize-thinking', cssClass: 'fontsize-thinking', default: 13, enabled: false, icon: 'üí≠' },
	];

	// V0.2 Â§çÂà∂ÈÖçÁΩÆÔºöÈÄâÊã©Âô®Â∑≤ÈÄÇÈÖç
	const COPY_CONFIGS = [
		{ id: 'copy-user', selector: '.bg-gray-500\\/15', textSelector: '.whitespace-pre-wrap', type: 'user' },
		{ id: 'copy-thinking', selector: '.opacity-70.leading-relaxed', textSelector: null, type: 'thinking' },
		{ id: 'copy-ai', selector: '.leading-relaxed.select-text:not(.opacity-70)', textSelector: null, type: 'ai' },
	];

	const HOTKEY_OPTIONS = [
		{ id: 'enter', label: 'Enter', check: (e) => e.key === 'Enter' && !e.metaKey && !e.ctrlKey && !e.shiftKey },
		{ id: 'cmd+enter', label: '‚åò Cmd + Enter', check: (e) => e.key === 'Enter' && e.metaKey },
		{ id: 'ctrl+enter', label: 'Ctrl + Enter', check: (e) => e.key === 'Enter' && e.ctrlKey },
		{ id: 'shift+enter', label: '‚áß Shift + Enter', check: (e) => e.key === 'Enter' && e.shiftKey },
	];

	const AUTO_ACCEPT_CONFIGS = [
		{ id: 'accept', label: 'Accept', defaultEnabled: false },
		{ id: 'retry', label: 'Retry', defaultEnabled: true },
		{ id: 'run', label: 'Run', defaultEnabled: true },
		{ id: 'apply', label: 'Apply', defaultEnabled: true },
		{ id: 'execute', label: 'Execute', defaultEnabled: true },
		{ id: 'confirm', label: 'Confirm', defaultEnabled: true },
		{ id: 'allow', label: 'Allow', defaultEnabled: true },
	];

	const DEFAULT_BANNED_COMMANDS = ['rm -rf /','rm -rf ~','rm -rf *','format c:','del /f /s /q','rmdir /s /q',':(){:|:&};:','dd if=','mkfs.','> /dev/sda','chmod -R 777 /'];

	const defaultSettings = {
		lang: 'zh',
		masterEnabled: false,
		colors: COLOR_CONFIGS.reduce((acc, c) => { acc[c.id] = { color: c.default, enabled: c.enabled }; return acc; }, {}),
		fontsizeMasterEnabled: false,
		fontsizes: FONTSIZE_CONFIGS.reduce((acc, c) => { acc[c.id] = { size: c.default, enabled: c.enabled }; return acc; }, {}),
		copyEnabled: false,
		copy: COPY_CONFIGS.reduce((acc, c) => { acc[c.id] = { enabled: true }; return acc; }, {}),
		hotkeyEnabled: false, sendHotkey: 'cmd+enter',
		autoAcceptEnabled: false,
		autoAcceptPatterns: AUTO_ACCEPT_CONFIGS.reduce((acc, c) => { acc[c.id] = c.defaultEnabled; return acc; }, {}),
		bannedCommands: [...DEFAULT_BANNED_COMMANDS],
		autoAcceptStats: { clicks: 0, blocked: 0, verified: 0 },
		autoUpdateEnabled: true, latexEnabled: false,
	};

	// ===== Â≠òÂÇ® =====
	function loadSettings() {
		try {
			const saved = localStorage.getItem(STORAGE_KEY);
			if (saved) {
					const p = JSON.parse(saved);
				return { ...defaultSettings, ...p,
					colors: { ...defaultSettings.colors, ...p.colors },
					fontsizes: { ...defaultSettings.fontsizes, ...p.fontsizes },
					copy: { ...defaultSettings.copy, ...p.copy },
					autoAcceptPatterns: { ...defaultSettings.autoAcceptPatterns, ...p.autoAcceptPatterns },
					autoAcceptStats: { ...defaultSettings.autoAcceptStats, ...p.autoAcceptStats },
					bannedCommands: p.bannedCommands ?? [...DEFAULT_BANNED_COMMANDS],
				};
			}
		} catch (e) { /* ignore */ }
		return { ...defaultSettings };
	}
	function saveSettings(s) { try { localStorage.setItem(STORAGE_KEY, JSON.stringify(s)); } catch (e) { /* ignore */ } }
	let currentSettings = loadSettings();

	// ===== Â∫îÁî®È¢úËâ≤/Â≠ó‰ΩìËÆæÁΩÆ =====
	function applyColorSettings() {
		COLOR_CONFIGS.forEach(c => {
			const s = currentSettings.colors[c.id];
			document.documentElement.style.setProperty(c.cssVar, s.color);
			document.body.classList.toggle(c.cssClass, currentSettings.masterEnabled && s.enabled);
		});
	}
	function applyFontsizeSettings() {
		FONTSIZE_CONFIGS.forEach(c => {
			const s = currentSettings.fontsizes[c.id];
			document.documentElement.style.setProperty(c.cssVar, s.size + 'px');
			document.body.classList.toggle(c.cssClass, currentSettings.fontsizeMasterEnabled && s.enabled);
		});
	}

	// ===== DOM Â∑•ÂÖ∑ =====
	function el(tag, cls, text) { const e = document.createElement(tag); if (cls) e.className = cls; if (text) e.textContent = text; return e; }
	function createToggle(checked, onChange) {
		const label = el('label', 'ab-toggle');
		const input = document.createElement('input'); input.type = 'checkbox'; input.checked = checked;
		input.addEventListener('change', () => onChange(input.checked));
		const slider = el('span', 'ab-toggle-slider');
		label.appendChild(input); label.appendChild(slider); return label;
	}
	function createMainToggle(i18nKey, checked, onChange) {
		const w = el('div', 'ab-main-toggle');
		const lb = el('span', 'ab-main-toggle-label', t(i18nKey)); lb.dataset.i18n = i18nKey;
		w.appendChild(lb); w.appendChild(createToggle(checked, onChange)); return w;
	}
	function createAccordion(i18nKey, expanded) {
		const item = el('div', 'ab-accordion' + (expanded ? ' expanded' : ''));
		const header = el('div', 'ab-accordion-header');
		const title = el('span', 'ab-accordion-title', t(i18nKey)); title.dataset.i18n = i18nKey;
		const icon = el('span', 'ab-accordion-icon', '‚ñº');
		header.appendChild(title); header.appendChild(icon);
		header.addEventListener('click', () => item.classList.toggle('expanded'));
		const body = el('div', 'ab-accordion-body');
		const inner = el('div', 'ab-accordion-inner');
		body.appendChild(inner); item.appendChild(header); item.appendChild(body);
		return { item, inner };
	}
	function createSettingItem(icon, i18nKey) {
		const row = el('div', 'ab-setting');
		const left = el('div', 'ab-setting-left');
		left.appendChild(el('span', 'ab-setting-icon', icon));
		const name = el('span', 'ab-setting-name', t(i18nKey)); name.dataset.i18n = i18nKey;
		left.appendChild(name);
		const right = el('div', 'ab-setting-right');
		row.appendChild(left); row.appendChild(right);
		return { row, right };
	}

	// ===== I18N Êõ¥Êñ∞ =====
	let langSwitchBtn = null;
	function updateLanguage() {
		document.querySelectorAll('[data-i18n]').forEach(e => {
			const key = e.dataset.i18n;
			const val = t(key); if (val) e.textContent = val;
		});
		if (langSwitchBtn) langSwitchBtn.textContent = currentSettings.lang === 'zh' ? 'üåê English' : 'üåê ‰∏≠Êñá';
	}

	// ===== ÂàõÂª∫ËÆæÁΩÆÈù¢Êùø =====
	function createSettingsUI(panelEl) {
		if (panelEl.querySelector('#ab-settings-btn')) return;

		// ÊÇ¨ÊµÆÊåâÈíÆ
		const btn = el('button'); btn.id = 'ab-settings-btn'; btn.title = 'Antigravity Better Settings';
		const svgNS = 'http://www.w3.org/2000/svg';
		const svg = document.createElementNS(svgNS, 'svg'); svg.setAttribute('viewBox', '0 0 24 24');
		const path = document.createElementNS(svgNS, 'path');
		path.setAttribute('d', 'M19.14,12.94c0.04-0.31,0.06-0.63,0.06-0.94c0-0.31-0.02-0.63-0.06-0.94l2.03-1.58c0.18-0.14,0.23-0.41,0.12-0.61l-1.92-3.32c-0.12-0.22-0.37-0.29-0.59-0.22l-2.39,0.96c-0.5-0.38-1.03-0.7-1.62-0.94L14.4,2.81c-0.04-0.24-0.24-0.41-0.48-0.41h-3.84c-0.24,0-0.43,0.17-0.47,0.41L9.25,5.35C8.66,5.59,8.12,5.92,7.63,6.29L5.24,5.33c-0.22-0.08-0.47,0-0.59,0.22L2.74,8.87C2.62,9.08,2.66,9.34,2.86,9.48l2.03,1.58C4.84,11.37,4.8,11.69,4.8,12s0.02,0.63,0.06,0.94l-2.03,1.58c-0.18,0.14-0.23,0.41-0.12,0.61l1.92,3.32c0.12,0.22,0.37,0.29,0.59,0.22l2.39-0.96c0.5,0.38,1.03,0.7,1.62,0.94l0.36,2.54c0.05,0.24,0.24,0.41,0.48,0.41h3.84c0.24,0,0.44-0.17,0.47-0.41l0.36-2.54c0.59-0.24,1.13-0.56,1.62-0.94l2.39,0.96c0.22,0.08,0.47,0,0.59-0.22l1.92-3.32c0.12-0.22,0.07-0.47-0.12-0.61L19.14,12.94z M12,15.6c-1.98,0-3.6-1.62-3.6-3.6s1.62-3.6,3.6-3.6s3.6,1.62,3.6,3.6S13.98,15.6,12,15.6z');
		svg.appendChild(path); btn.appendChild(svg); panelEl.appendChild(btn);

		// ÈÅÆÁΩ©Â±Ç + ÂºπÁ™ó
		const overlay = el('div'); overlay.id = 'ab-overlay';
		const modal = el('div'); modal.id = 'ab-modal';

		// === Header ===
		const header = el('div', 'ab-header');
		const headerLeft = el('div', 'ab-header-left');
		const brand = el('span', 'ab-brand', 'Antigravity Better');
		const ver = el('span', 'ab-version', 'v' + APP_VERSION); brand.appendChild(ver);
		const links = el('div', 'ab-brand-links');
		const link1 = document.createElement('a'); link1.className = 'ab-brand-link'; link1.href = 'https://dpit.lib00.com'; link1.target = '_blank'; link1.textContent = 'üåê dpit.lib00.com';
		const link2 = document.createElement('a'); link2.className = 'ab-brand-link'; link2.href = 'https://github.com/016/Antigravity-Better'; link2.target = '_blank'; link2.textContent = 'üì¶ GitHub';
		links.appendChild(link1); links.appendChild(link2);
		headerLeft.appendChild(brand); headerLeft.appendChild(links);
		const headerRight = el('div', 'ab-header-right');
		langSwitchBtn = el('button', 'ab-lang-switch', currentSettings.lang === 'zh' ? 'üåê English' : 'üåê ‰∏≠Êñá');
		langSwitchBtn.addEventListener('click', () => { currentSettings.lang = currentSettings.lang === 'zh' ? 'en' : 'zh'; saveSettings(currentSettings); updateLanguage(); });
		const closeBtn = el('button', 'ab-close', '√ó');
		headerRight.appendChild(langSwitchBtn); headerRight.appendChild(closeBtn);
		header.appendChild(headerLeft); header.appendChild(headerRight);
		modal.appendChild(header);

		// === Tab ÂØºËà™ ===
		const tabNav = el('div', 'ab-tab-nav');
		const tabs = [
			{ id: 'appearance', i18n: 'tab_appearance' },
			{ id: 'features', i18n: 'tab_features' },
			{ id: 'system', i18n: 'tab_system' },
		];
		const tabContents = {};
		tabs.forEach((tab, i) => {
			const tbtn = el('button', 'ab-tab-btn' + (i === 0 ? ' active' : ''), t(tab.i18n));
			tbtn.dataset.i18n = tab.i18n; tbtn.dataset.tab = tab.id;
			tabNav.appendChild(tbtn);
			const content = el('div', 'ab-tab-content' + (i === 0 ? ' active' : ''));
			tabContents[tab.id] = content;
		});
		modal.appendChild(tabNav);

		// Tab ÂàáÊç¢ÈÄªËæë
		tabNav.addEventListener('click', (e) => {
			const tb = e.target.closest('.ab-tab-btn'); if (!tb) return;
			tabNav.querySelectorAll('.ab-tab-btn').forEach(b => b.classList.remove('active'));
			tb.classList.add('active');
			Object.values(tabContents).forEach(c => c.classList.remove('active'));
			tabContents[tb.dataset.tab].classList.add('active');
		});

		// === Body ===
		const body = el('div', 'ab-body');

		// ============ Tab: Â§ñËßÇ ============
		const tabAppearance = tabContents['appearance'];

		// -- È¢úËâ≤Ëá™ÂÆö‰πâ --
		const colorAcc = createAccordion('colors_title', true);
		colorAcc.inner.appendChild(createMainToggle('enable_custom_colors', currentSettings.masterEnabled, (v) => {
			currentSettings.masterEnabled = v; saveSettings(currentSettings); applyColorSettings();
		}));
		COLOR_CONFIGS.forEach(c => {
			const s = currentSettings.colors[c.id];
			const lbl = c.id === 'user-message' ? 'lbl_user_msg' : c.id === 'ai-response' ? 'lbl_ai_resp' : c.id === 'code-block' ? 'lbl_code' : c.id === 'action-status' ? 'lbl_status' : 'lbl_thinking';
			const { row, right } = createSettingItem(c.icon, lbl);
			right.appendChild(createToggle(s.enabled, (v) => { currentSettings.colors[c.id].enabled = v; saveSettings(currentSettings); applyColorSettings(); }));
			const ci = document.createElement('input'); ci.type = 'color'; ci.className = 'ab-color-input'; ci.value = s.color;
			ci.addEventListener('input', () => { currentSettings.colors[c.id].color = ci.value; saveSettings(currentSettings); applyColorSettings(); });
			right.appendChild(ci);
			colorAcc.inner.appendChild(row);
		});
		tabAppearance.appendChild(colorAcc.item);

		// -- Â≠ó‰ΩìÂ§ßÂ∞è --
		const fontAcc = createAccordion('fontsize_title', false);
		fontAcc.inner.appendChild(createMainToggle('enable_custom_fontsize', currentSettings.fontsizeMasterEnabled, (v) => {
			currentSettings.fontsizeMasterEnabled = v; saveSettings(currentSettings); applyFontsizeSettings();
		}));
		FONTSIZE_CONFIGS.forEach((c, idx) => {
			const s = currentSettings.fontsizes[c.id];
			const lbl = c.id === 'user-message' ? 'lbl_user_msg' : c.id === 'ai-response' ? 'lbl_ai_resp' : c.id === 'code-block' ? 'lbl_code' : c.id === 'action-status' ? 'lbl_status' : 'lbl_thinking';
			const { row, right } = createSettingItem(c.icon, lbl);
			right.appendChild(createToggle(s.enabled, (v) => { currentSettings.fontsizes[c.id].enabled = v; saveSettings(currentSettings); applyFontsizeSettings(); }));
			const fi = document.createElement('input'); fi.type = 'number'; fi.className = 'ab-fontsize-input'; fi.value = s.size; fi.min = 10; fi.max = 24;
			fi.addEventListener('change', () => { currentSettings.fontsizes[c.id].size = parseInt(fi.value) || c.default; saveSettings(currentSettings); applyFontsizeSettings(); });
			right.appendChild(fi); right.appendChild(document.createTextNode(' px'));
			// Á¨¨‰∏Ä‰∏™È°πÂä†ÂêåÊ≠•ÊåâÈíÆ
			if (idx === 0) {
				const syncBtn = el('button', 'ab-sync-btn', t('btn_sync')); syncBtn.dataset.i18n = 'btn_sync';
				syncBtn.addEventListener('click', () => {
					const val = parseInt(fi.value) || c.default;
					FONTSIZE_CONFIGS.forEach(fc => { currentSettings.fontsizes[fc.id].size = val; });
					saveSettings(currentSettings); applyFontsizeSettings();
					fontAcc.inner.querySelectorAll('.ab-fontsize-input').forEach(inp => inp.value = val);
				});
				right.appendChild(syncBtn);
			}
			fontAcc.inner.appendChild(row);
		});
		tabAppearance.appendChild(fontAcc.item);

		// -- LaTeX --
		const latexAcc = createAccordion('latex_title', false);
		const latexStatusEl = el('div', 'ab-save-status');
		latexAcc.inner.appendChild(createMainToggle('enable_latex', currentSettings.latexEnabled, (v) => {
			currentSettings.latexEnabled = v; saveSettings(currentSettings); applyLatexSettings();
		}));
		const latexDesc = el('div', 'ab-setting-desc', t('latex_desc')); latexDesc.dataset.i18n = 'latex_desc';
		latexAcc.inner.appendChild(latexDesc); latexAcc.inner.appendChild(latexStatusEl);
		tabAppearance.appendChild(latexAcc.item);

		// ============ Tab: ÂäüËÉΩ ============
		const tabFeatures = tabContents['features'];

		// -- ‰∏ÄÈîÆÂ§çÂà∂ --
		const copyAcc = createAccordion('copy_title', true);
		copyAcc.inner.appendChild(createMainToggle('enable_copy', currentSettings.copyEnabled, (v) => {
			currentSettings.copyEnabled = v; saveSettings(currentSettings); applyCopySettings(panelEl);
		}));
		const copyI18nMap = { 'copy-user': 'lbl_user_msg', 'copy-thinking': 'lbl_thinking', 'copy-ai': 'lbl_ai_resp' };
		const copyIconMap = { 'copy-user': 'üìù', 'copy-thinking': 'üí≠', 'copy-ai': 'ü§ñ' };
		COPY_CONFIGS.forEach(c => {
			const { row, right } = createSettingItem(copyIconMap[c.id], copyI18nMap[c.id]);
			right.appendChild(createToggle(currentSettings.copy[c.id]?.enabled ?? true, (v) => {
				currentSettings.copy[c.id].enabled = v; saveSettings(currentSettings);
				removeCopyButtons(panelEl); if (currentSettings.copyEnabled) injectCopyButtons(panelEl);
			}));
			copyAcc.inner.appendChild(row);
		});
		tabFeatures.appendChild(copyAcc.item);

		// -- Âø´Êç∑ÈîÆ --
		const hotkeyAcc = createAccordion('hotkey_title', false);
		hotkeyAcc.inner.appendChild(createMainToggle('enable_hotkey', currentSettings.hotkeyEnabled, (v) => {
			currentSettings.hotkeyEnabled = v; saveSettings(currentSettings); applyHotkeySettings();
		}));
		const { row: hkRow, right: hkRight } = createSettingItem('‚Üµ', 'lbl_send_hotkey');
		const hkSelect = el('select', 'ab-select-input');
		HOTKEY_OPTIONS.forEach(o => { const opt = el('option', null, o.label); opt.value = o.id; hkSelect.appendChild(opt); });
		hkSelect.value = currentSettings.sendHotkey;
		hkSelect.addEventListener('change', () => { currentSettings.sendHotkey = hkSelect.value; saveSettings(currentSettings); if (currentSettings.hotkeyEnabled) applyHotkeySettings(); });
		hkRight.appendChild(hkSelect);
		hotkeyAcc.inner.appendChild(hkRow);
		tabFeatures.appendChild(hotkeyAcc.item);

		// -- Ëá™Âä®Êìç‰Ωú --
		const autoAcc = createAccordion('auto_accept_title', false);
		autoAcc.inner.appendChild(createMainToggle('enable_auto_accept', currentSettings.autoAcceptEnabled, (v) => {
			currentSettings.autoAcceptEnabled = v; saveSettings(currentSettings); applyAutoAcceptSettings(panelEl);
		}));
		const aaDesc = el('div', 'ab-setting-desc', t('auto_accept_desc')); aaDesc.dataset.i18n = 'auto_accept_desc';
		autoAcc.inner.appendChild(aaDesc);
		// Pattern grid
		const patternGrid = el('div', 'ab-pattern-grid');
		AUTO_ACCEPT_CONFIGS.forEach(c => {
			const isOn = currentSettings.autoAcceptPatterns[c.id];
			const lbl = el('label', 'ab-pattern-item' + (isOn ? ' active' : ''));
			const cb = document.createElement('input'); cb.type = 'checkbox'; cb.checked = isOn;
			cb.addEventListener('change', () => { currentSettings.autoAcceptPatterns[c.id] = cb.checked; lbl.classList.toggle('active', cb.checked); saveSettings(currentSettings); });
			lbl.appendChild(cb); lbl.appendChild(el('span', null, c.label)); patternGrid.appendChild(lbl);
		});
		autoAcc.inner.appendChild(patternGrid);
		// Stats
		const statsPanel = el('div', 'ab-stats-panel');
		const statClicksEl = el('span', 'ab-stat-value', String(currentSettings.autoAcceptStats.clicks));
		const statBlockedEl = el('span', 'ab-stat-value', String(currentSettings.autoAcceptStats.blocked));
		const statVerifiedEl = el('span', 'ab-stat-value', String(currentSettings.autoAcceptStats.verified));
		[{ icon: '‚úÖ', el: statClicksEl, i18n: 'stat_clicks' }, { icon: 'üõ°Ô∏è', el: statBlockedEl, i18n: 'stat_blocked' }, { icon: '‚úì', el: statVerifiedEl, i18n: 'stat_verified' }].forEach(s => {
			const item = el('div', 'ab-stat-item');
			item.appendChild(el('span', 'ab-stat-icon', s.icon)); item.appendChild(s.el);
			const lb = el('span', 'ab-stat-label', t(s.i18n)); lb.dataset.i18n = s.i18n; item.appendChild(lb);
			statsPanel.appendChild(item);
		});
		autoAcc.inner.appendChild(statsPanel);
		tabFeatures.appendChild(autoAcc.item);

		// -- ÂÆâÂÖ®ËßÑÂàô --
		const bannedAcc = createAccordion('banned_title', false);
		const bannedDescEl = el('div', 'ab-setting-desc', t('banned_desc')); bannedDescEl.dataset.i18n = 'banned_desc';
		bannedAcc.inner.appendChild(bannedDescEl);
		const bannedInput = el('textarea', 'ab-textarea'); bannedInput.rows = 6;
		bannedInput.value = (currentSettings.bannedCommands || []).join('\n');
		bannedAcc.inner.appendChild(bannedInput);
		const bannedBtnGroup = el('div', 'ab-btn-group');
		const bannedSaveStatus = el('div', 'ab-save-status');
		const saveBtn = el('button', 'ab-btn primary', t('btn_save')); saveBtn.dataset.i18n = 'btn_save';
		saveBtn.addEventListener('click', () => {
			currentSettings.bannedCommands = bannedInput.value.split('\n').map(l => l.trim()).filter(l => l);
			saveSettings(currentSettings); bannedSaveStatus.textContent = t('banned_saved'); setTimeout(() => bannedSaveStatus.textContent = '', 3000);
		});
		const resetBtn = el('button', 'ab-btn secondary', t('btn_reset')); resetBtn.dataset.i18n = 'btn_reset';
		resetBtn.addEventListener('click', () => {
			currentSettings.bannedCommands = [...DEFAULT_BANNED_COMMANDS]; bannedInput.value = DEFAULT_BANNED_COMMANDS.join('\n');
			saveSettings(currentSettings); bannedSaveStatus.textContent = t('banned_reset'); setTimeout(() => bannedSaveStatus.textContent = '', 3000);
		});
		bannedBtnGroup.appendChild(saveBtn); bannedBtnGroup.appendChild(resetBtn);
		bannedAcc.inner.appendChild(bannedBtnGroup); bannedAcc.inner.appendChild(bannedSaveStatus);
		tabFeatures.appendChild(bannedAcc.item);

		// ============ Tab: Á≥ªÁªü ============
		const tabSystem = tabContents['system'];
		const verAcc = createAccordion('version_title', true);
		const { row: autoRow, right: autoRight } = createSettingItem('üîÑ', 'lbl_auto_update');
		autoRight.appendChild(createToggle(currentSettings.autoUpdateEnabled, (v) => { currentSettings.autoUpdateEnabled = v; saveSettings(currentSettings); }));
		verAcc.inner.appendChild(autoRow);
		const { row: manualRow, right: manualRight } = createSettingItem('üëâ', 'lbl_manual_update');
		const updateStatusEl = el('div', 'ab-save-status');
		const checkBtn = el('button', 'ab-btn primary', t('btn_check_update')); checkBtn.dataset.i18n = 'btn_check_update';
		checkBtn.addEventListener('click', async () => {
			updateStatusEl.textContent = t('update_checking'); checkBtn.disabled = true;
			const result = await checkForUpdate();
			updateStatusEl.textContent = result === 'found' ? t('update_found') : result === 'latest' ? t('update_latest') : t('update_failed');
			checkBtn.disabled = false; setTimeout(() => updateStatusEl.textContent = '', 3000);
		});
		manualRight.appendChild(checkBtn);
		verAcc.inner.appendChild(manualRow); verAcc.inner.appendChild(updateStatusEl);
		tabSystem.appendChild(verAcc.item);

		// ÁªÑË£Ö body
		Object.values(tabContents).forEach(c => body.appendChild(c));
		modal.appendChild(body);
		overlay.appendChild(modal); panelEl.appendChild(overlay);

		// === ‰∫ã‰ª∂ ===
		btn.addEventListener('click', () => { overlay.classList.add('show'); requestAnimationFrame(() => overlay.classList.add('visible')); });
		const closeModal = () => { overlay.classList.remove('visible'); setTimeout(() => overlay.classList.remove('show'), 300); };
		closeBtn.addEventListener('click', closeModal);
		overlay.addEventListener('click', (e) => { if (e.target === overlay) closeModal(); });

		console.log('[AB] ‚úÖ ËÆæÁΩÆÈù¢ÊùøÂàõÂª∫ÊàêÂäü');

		// ===== ÂäüËÉΩÈÄªËæëÂáΩÊï∞ÂºïÁî® (ÈúÄË¶Å panelEl) =====

		// -- Êõ¥Êñ∞ÁªüËÆ° --
		function updateStats(delta) {
			if (delta.clicks) currentSettings.autoAcceptStats.clicks += delta.clicks;
			if (delta.blocked) currentSettings.autoAcceptStats.blocked += delta.blocked;
			if (delta.verified) currentSettings.autoAcceptStats.verified += delta.verified;
			saveSettings(currentSettings);
			statClicksEl.textContent = currentSettings.autoAcceptStats.clicks;
			statBlockedEl.textContent = currentSettings.autoAcceptStats.blocked;
			statVerifiedEl.textContent = currentSettings.autoAcceptStats.verified;
		}
		// Â≠òÂÖ• panelEl ‰æõÂ§ñÈÉ®Ë∞ÉÁî®
		panelEl._abUpdateStats = updateStats;
	}

	// ===== Â§çÂà∂ÂäüËÉΩ =====
	let copyObserver = null;
	const COPY_ICON_SVG = 'M16 1H4c-1.1 0-2 .9-2 2v14h2V3h12V1zm3 4H8c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h11c1.1 0 2-.9 2-2V7c0-1.1-.9-2-2-2zm0 16H8V7h11v14z';
	const CHECK_ICON_SVG = 'M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41z';

	// ÊèêÂèñÁ∫ØÊñáÊú¨ÔºåÊéíÈô§ <style>/<script> Ê†áÁ≠æÂÜÖÂÆπ
	function getCleanText(el) {
		const clone = el.cloneNode(true);
		clone.querySelectorAll('style, script').forEach(s => s.remove());
		return clone.textContent.trim();
	}

	function createCopyButton(getText) {
		const btn = el('button', 'copy-btn');
		const svgNS = 'http://www.w3.org/2000/svg';
		function setSvg(d) { while (btn.firstChild) btn.removeChild(btn.firstChild); const s = document.createElementNS(svgNS, 'svg'); s.setAttribute('viewBox', '0 0 24 24'); const p = document.createElementNS(svgNS, 'path'); p.setAttribute('d', d); s.appendChild(p); btn.appendChild(s); }
		setSvg(COPY_ICON_SVG);
		btn.addEventListener('click', (e) => {
			e.stopPropagation(); e.preventDefault();
			const ta = document.createElement('textarea'); ta.value = getText(); ta.style.position = 'fixed'; ta.style.left = '-9999px';
			document.body.appendChild(ta); ta.select(); try { document.execCommand('copy'); } catch (err) {} document.body.removeChild(ta);
			setSvg(CHECK_ICON_SVG); btn.classList.add('copied');
			setTimeout(() => { setSvg(COPY_ICON_SVG); btn.classList.remove('copied'); }, 1500);
		});
		return btn;
	}
	function injectCopyButtons(panelEl) {
		if (!currentSettings.copyEnabled) return;
		const scope = panelEl || document.querySelector('.antigravity-agent-side-panel');
		if (!scope) return;
		COPY_CONFIGS.forEach(c => {
			if (!currentSettings.copy[c.id]?.enabled) return;
			scope.querySelectorAll(c.selector).forEach(target => {
				if (target.querySelector('.copy-btn') || target.closest('#ab-overlay')) return;
				target.classList.add('copy-target');
				const getText = () => c.textSelector ? (target.querySelector(c.textSelector)?.textContent || getCleanText(target)) : getCleanText(target);
				target.appendChild(createCopyButton(getText));
			});
		});
	}
	function removeCopyButtons(panelEl) {
		const scope = panelEl || document.querySelector('.antigravity-agent-side-panel');
		if (!scope) return;
		scope.querySelectorAll('.copy-btn').forEach(b => b.remove());
		scope.querySelectorAll('.copy-target').forEach(e => e.classList.remove('copy-target'));
	}
	function applyCopySettings(panelEl) {
		if (currentSettings.copyEnabled) {
			if (!copyObserver) {
				const scope = panelEl || document.querySelector('.antigravity-agent-side-panel');
				if (scope) { copyObserver = new MutationObserver(() => setTimeout(() => injectCopyButtons(panelEl), 100)); copyObserver.observe(scope, { childList: true, subtree: true }); }
				injectCopyButtons(panelEl);
			}
		} else { if (copyObserver) { copyObserver.disconnect(); copyObserver = null; } removeCopyButtons(panelEl); }
	}

	// ===== Âø´Êç∑ÈîÆÂäüËÉΩ =====
	let hotkeyHandler = null;
	const INPUT_SELECTOR = 'div[contenteditable="true"][data-lexical-editor="true"]';
	const SEND_BTN_SELECTOR = 'button[data-tooltip-id="input-send-button-send-tooltip"]';

	function applyHotkeySettings() {
		if (hotkeyHandler) { document.removeEventListener('keydown', hotkeyHandler, { capture: true }); hotkeyHandler = null; }
		if (!currentSettings.hotkeyEnabled) return;
		const selected = currentSettings.sendHotkey;
		const config = HOTKEY_OPTIONS.find(h => h.id === selected);
		hotkeyHandler = function (e) {
			const inputEl = e.target.closest(INPUT_SELECTOR);
			if (!inputEl || e.key !== 'Enter') return;
			if (inputEl.hasAttribute('aria-activedescendant')) return;
			const menu = document.querySelector('.lexical-typeahead-menu');
			if (menu && menu.style.display !== 'none') return;
			if (config && config.check(e)) {
				e.preventDefault(); e.stopPropagation(); e.stopImmediatePropagation();
				const sendBtn = document.querySelector(SEND_BTN_SELECTOR);
				if (sendBtn) sendBtn.click();
			} else if (e.key === 'Enter' && (!e.shiftKey || selected === 'shift+enter')) {
				e.stopPropagation(); e.stopImmediatePropagation();
			}
		};
		document.addEventListener('keydown', hotkeyHandler, { capture: true });
	}

	// ===== Ëá™Âä®Êìç‰ΩúÂäüËÉΩ =====
	let autoAcceptObserver = null;
	function isAutoAcceptButton(btn) {
		const text = (btn.textContent || '').trim().toLowerCase();
		if (!text || text.length > 50) return false;
		const patterns = Object.entries(currentSettings.autoAcceptPatterns).filter(([_, v]) => v).map(([k]) => k);
		if (!patterns.length) return false;
		const rejects = ['skip', 'reject', 'cancel', 'close', 'refine', 'dismiss'];
		if (rejects.some(r => text.includes(r))) return false;
		if (!patterns.some(p => text.includes(p))) return false;
		const style = window.getComputedStyle(btn); const rect = btn.getBoundingClientRect();
		return style.display !== 'none' && rect.width > 0 && !btn.disabled;
	}
	function findNearbyCommandText(btnEl) {
		let cmd = ''; let container = btnEl.parentElement; let depth = 0;
		while (container && depth < 10) {
			let sib = container.previousElementSibling; let sc = 0;
			while (sib && sc < 5) { if (/^(PRE|CODE)$/.test(sib.tagName)) cmd += ' ' + sib.textContent.trim(); sib.querySelectorAll('pre, code').forEach(e => cmd += ' ' + e.textContent.trim()); sib = sib.previousElementSibling; sc++; }
			if (cmd.length > 10) break; container = container.parentElement; depth++;
		}
		return cmd.trim().toLowerCase();
	}
	function isCommandBanned(text) {
		if (!text) return false;
		const list = currentSettings.bannedCommands || [];
		return list.some(p => p && text.toLowerCase().includes(p.toLowerCase()));
	}
	async function performAutoAccept(panelEl) {
		if (!currentSettings.autoAcceptEnabled) return;
		const scope = panelEl || document.querySelector('.antigravity-agent-side-panel');
		if (!scope) return;
		const buttons = scope.querySelectorAll('button');
		for (const btn of buttons) {
			if (!isAutoAcceptButton(btn)) continue;
			const text = (btn.textContent || '').trim().toLowerCase();
			if (/run|execute/i.test(text)) { const nearby = findNearbyCommandText(btn); if (isCommandBanned(nearby)) { if (scope._abUpdateStats) scope._abUpdateStats({ blocked: 1 }); continue; } }
			btn.dispatchEvent(new MouseEvent('click', { bubbles: true, cancelable: true }));
			if (scope._abUpdateStats) scope._abUpdateStats({ clicks: 1 });
			await new Promise(r => setTimeout(r, 100));
		}
	}
	function applyAutoAcceptSettings(panelEl) {
		if (autoAcceptObserver) { autoAcceptObserver.disconnect(); autoAcceptObserver = null; }
		if (!currentSettings.autoAcceptEnabled) return;
		const scope = panelEl || document.querySelector('.antigravity-agent-side-panel');
		if (!scope) return;
		autoAcceptObserver = new MutationObserver(() => { clearTimeout(window._abAATimer); window._abAATimer = setTimeout(() => performAutoAccept(panelEl), 500); });
		autoAcceptObserver.observe(scope, { childList: true, subtree: true });
		performAutoAccept(panelEl);
	}

	// ===== LaTeX Ê∏≤Êüì =====
	let katexLoaded = false, katexLoading = false, latexObserver = null;
	const KATEX_CSS = 'https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.css';
	const KATEX_JS = 'https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.js';

	function loadKaTeX() {
		return new Promise((resolve, reject) => {
			if (katexLoaded) { resolve(); return; }
			if (katexLoading) { const iv = setInterval(() => { if (katexLoaded) { clearInterval(iv); resolve(); } }, 100); return; }
			katexLoading = true;
			// CSP Âè™ÂÖÅËÆ∏ self/unsafe-inline/unsafe-eval/blobÔºåÂ§ñÈÉ® CDN Ë¢´ÈòªÊ≠¢
			// fetch Ëé∑ÂèñÂÜÖÂÆπÂêéÔºöCSS ÂÜÖËÅî <style>ÔºåJS Áî® IIFE ÂåÖË£ÖÂêéÈÄöËøá blob URL Âä†ËΩΩ
			// IIFE ÂèÇÊï∞ÈÅÆËîΩ module/exports/defineÔºåÂº∫Âà∂ UMD Ëµ∞ window ÂÖ®Â±ÄÂàÜÊîØ
			Promise.all([
				fetch(KATEX_CSS).then(r => r.text()),
				fetch(KATEX_JS).then(r => r.text())
			]).then(([css, js]) => {
				const style = document.createElement('style'); style.textContent = css; document.head.appendChild(style);
				// ÂåÖË£Ö IIFEÔºöÈÅÆËîΩ Electron ÂÖ®Â±ÄÁöÑ module/exports/define
				const wrappedJs = '(function(module, exports, define) {\n' + js + '\n}).call(window, undefined, undefined, undefined);';
				const blob = new Blob([wrappedJs], { type: 'application/javascript' });
				const blobUrl = URL.createObjectURL(blob);
				const script = document.createElement('script');
				script.src = abPolicy ? abPolicy.createScriptURL(blobUrl) : blobUrl;
				script.onload = () => {
					URL.revokeObjectURL(blobUrl); katexLoaded = true; katexLoading = false;
					console.log('[AB] ‚úÖ KaTeX Âä†ËΩΩÊàêÂäü, window.katex:', !!window.katex);
					resolve();
				};
				script.onerror = () => { URL.revokeObjectURL(blobUrl); katexLoading = false; reject(new Error('KaTeX blob load failed')); };
				document.head.appendChild(script);
			}).catch(e => { katexLoading = false; reject(new Error('KaTeX fetch failed: ' + e.message)); });
		});
	}
	// Ê∏≤ÊüìÂçï‰∏™ÂÖÉÁ¥† (p/li) ‰∏≠ÁöÑÂÜÖËÅî/ÂùóÁ∫ß LaTeX
	function processLatexInElement(elem) {
		const text = elem.textContent;
		const pattern = /(\$\$[\s\S]+?\$\$|\$(?!\$)(?:[^$\n]|\n(?!\n))+?\$(?!\$))/g;
		if (!pattern.test(text)) return false; pattern.lastIndex = 0;
		// ÂØπ‰∫éÂåÖÂê´ $$ ÁöÑÂùóÁ∫ßÂÖ¨ÂºèÊÆµËêΩÔºåÊï¥ÊÆµÊõøÊç¢
		const blockPattern = /^\s*\$\$([\s\S]+?)\$\$\s*$/;
		const blockMatch = text.match(blockPattern);
		if (blockMatch) {
			try {
				const html = window.katex.renderToString(blockMatch[1].trim(), { throwOnError: false, displayMode: true });
				const wrap = document.createElement('div');
				wrap.className = 'latex-block latex-rendered';
				wrap.dataset.latexOriginal = text;
				wrap.dataset.latexOriginalTag = elem.tagName.toLowerCase();
				safeSetHTML(wrap, html);
				elem.parentNode.replaceChild(wrap, elem);
				return true;
			} catch (e) { return false; }
		}
		// ÂÜÖËÅîÂÖ¨ÂºèÔºöÈÄê‰∏™ÊñáÊú¨ËäÇÁÇπÂ§ÑÁêÜ
		const walker = document.createTreeWalker(elem, NodeFilter.SHOW_TEXT, null, false);
		const nodes = []; let n;
		while (n = walker.nextNode()) {
			if (n.parentNode && /^(code|pre|script|style)$/i.test(n.parentNode.tagName)) continue;
			if (n.parentNode && n.parentNode.classList && n.parentNode.classList.contains('latex-rendered')) continue;
			if (n.textContent.includes('$')) nodes.push(n);
		}
		let has = false;
		for (let i = nodes.length - 1; i >= 0; i--) {
			const textNode = nodes[i];
			const nodeText = textNode.textContent;
			const inlinePattern = /(\$\$[\s\S]+?\$\$|\$(?!\$)(?:[^$\n]|\n(?!\n))+?\$(?!\$))/g;
			if (!inlinePattern.test(nodeText)) continue; inlinePattern.lastIndex = 0;
			const frag = document.createDocumentFragment(); let last = 0, m;
			while ((m = inlinePattern.exec(nodeText)) !== null) {
				if (m.index > last) frag.appendChild(document.createTextNode(nodeText.slice(last, m.index)));
				const full = m[0], isBlock = full.startsWith('$$');
				const formula = isBlock ? full.slice(2, -2).trim() : full.slice(1, -1).trim();
				try {
					const html = window.katex.renderToString(formula, { throwOnError: false, displayMode: isBlock });
					const wrap = document.createElement(isBlock ? 'div' : 'span');
					wrap.className = isBlock ? 'latex-block latex-rendered' : 'latex-rendered';
					wrap.dataset.latexOriginal = full; safeSetHTML(wrap, html); frag.appendChild(wrap);
				} catch (e) { frag.appendChild(document.createTextNode(full)); }
				last = m.index + full.length;
			}
			if (last < nodeText.length) frag.appendChild(document.createTextNode(nodeText.slice(last)));
			textNode.parentNode.replaceChild(frag, textNode); has = true;
		}
		return has;
	}
	// Ê∏≤Êüì latex ‰ª£Á†ÅÂùóÔºàËØ≠Ë®ÄÊ†áËÆ∞‰∏∫ "latex" ÁöÑ <pre> ÂÖÉÁ¥†Ôºâ
	function processLatexCodeBlocks(scope) {
		// V0.2 ‰ª£Á†ÅÂùóÁªìÊûÑ: <pre> > div.relative... > div(Ê†áÈ¢òÂê´ËØ≠Ë®ÄÂêç) + div.p-3(‰ª£Á†ÅÂÜÖÂÆπ)
		scope.querySelectorAll('pre').forEach(pre => {
			if (pre.dataset.latexCodeProcessed) return;
			const codeContainer = pre.querySelector('div');
			if (!codeContainer) return;
			// Êü•ÊâæËØ≠Ë®ÄÊ†áÁ≠æ
			const langLabel = codeContainer.querySelector('.font-sans.text-sm');
			if (!langLabel || langLabel.textContent.trim().toLowerCase() !== 'latex') return;
			// Ëé∑Âèñ‰ª£Á†ÅÂÜÖÂÆπÔºà‰ªÖ‰ªé .line-content ÊèêÂèñÔºåÈÅøÂÖçÂåÖÂê´ <style> Ê†áÁ≠æÊñáÊú¨Ôºâ
			const codeBody = codeContainer.querySelector('.p-3');
			if (!codeBody) return;
			const lineContents = codeBody.querySelectorAll('.line-content');
			const formula = lineContents.length > 0
				? Array.from(lineContents).map(l => l.textContent).join('\n').trim()
				: codeBody.textContent.trim();
			if (!formula) return;
			try {
				const html = window.katex.renderToString(formula, { throwOnError: false, displayMode: true });
				const rendered = document.createElement('div');
				rendered.className = 'latex-code-rendered latex-rendered';
				rendered.dataset.latexOriginal = formula;
				safeSetHTML(rendered, html);
				// ‰øùÁïôÊ†áÈ¢òÊ†èÔºåÊõøÊç¢‰ª£Á†ÅÂÜÖÂÆπÂå∫Âüü
				codeBody.dataset.latexCodeOriginalDisplay = codeBody.style.display || '';
				codeBody.style.display = 'none';
				codeBody.parentNode.insertBefore(rendered, codeBody.nextSibling);
				pre.dataset.latexCodeProcessed = 'true';
			} catch (e) { /* ignore render errors */ }
		});
	}
	function scanAndRenderLatex(panelEl) {
		if (!currentSettings.latexEnabled || !katexLoaded) return;
		const scope = panelEl || document.querySelector('.antigravity-agent-side-panel');
		if (!scope) return;
		// 1. Â§ÑÁêÜÊ≠£Êñá‰∏≠ÁöÑÂÜÖËÅî/ÂùóÁ∫ß LaTeX
		scope.querySelectorAll('.leading-relaxed.select-text:not(.opacity-70)').forEach(prose => {
			if (prose.dataset.latexProcessed) return;
			const elems = prose.querySelectorAll('p, li');
			let has = false;
			elems.forEach(elem => { if (processLatexInElement(elem)) has = true; });
			if (has) prose.dataset.latexProcessed = 'true';
		});
		// 2. Â§ÑÁêÜ latex ‰ª£Á†ÅÂùó
		processLatexCodeBlocks(scope);
	}
	function revertLatex(panelEl) {
		const scope = panelEl || document.querySelector('.antigravity-agent-side-panel');
		if (!scope) return;
		// ÂõûÈÄÄÂÜÖËÅî/ÂùóÁ∫ßÂÖ¨Âºè
		scope.querySelectorAll('.latex-rendered:not(.latex-code-rendered)').forEach(e => {
			const orig = e.dataset.latexOriginal;
			if (!orig) return;
			const origTag = e.dataset.latexOriginalTag;
			if (origTag) {
				// Êï¥ÊÆµÊõøÊç¢ÂõûÂéüÂßãÂÖÉÁ¥†
				const restored = document.createElement(origTag);
				restored.textContent = orig;
				e.parentNode.replaceChild(restored, e);
			} else {
				e.parentNode.replaceChild(document.createTextNode(orig), e);
			}
		});
		// ÂõûÈÄÄ latex ‰ª£Á†ÅÂùó
		scope.querySelectorAll('.latex-code-rendered').forEach(e => {
			const codeBody = e.previousElementSibling;
			if (codeBody && codeBody.dataset.latexCodeOriginalDisplay !== undefined) {
				codeBody.style.display = codeBody.dataset.latexCodeOriginalDisplay || '';
				delete codeBody.dataset.latexCodeOriginalDisplay;
			}
			e.remove();
		});
		scope.querySelectorAll('[data-latex-processed]').forEach(e => delete e.dataset.latexProcessed);
		scope.querySelectorAll('[data-latex-code-processed]').forEach(e => delete e.dataset.latexCodeProcessed);
	}
	async function applyLatexSettings(panelEl) {
		if (latexObserver) { latexObserver.disconnect(); latexObserver = null; }
		if (!currentSettings.latexEnabled) { revertLatex(panelEl); return; }
		try {
			await loadKaTeX();
			const scope = panelEl || document.querySelector('.antigravity-agent-side-panel');
			if (scope) { latexObserver = new MutationObserver(() => { clearTimeout(window._abLTTimer); window._abLTTimer = setTimeout(() => scanAndRenderLatex(panelEl), 300); }); latexObserver.observe(scope, { childList: true, subtree: true }); }
			scanAndRenderLatex(panelEl);
		} catch (e) { console.warn('[AB] LaTeX init failed:', e.message); }
	}

	// ===== ÁâàÊú¨Ê£ÄÊµã =====
	const VERSION_API = 'https://hub.lib00.com/api/v1/antigravity-better/version';
	function isNewerVersion(remote, local) {
		const r = remote.replace(/^v/i, '').split('.').map(Number);
		const l = local.replace(/^v/i, '').split('.').map(Number);
		for (let i = 0; i < Math.max(r.length, l.length); i++) { if ((r[i]||0) > (l[i]||0)) return true; if ((r[i]||0) < (l[i]||0)) return false; }
		return false;
	}
	async function checkForUpdate() {
		try {
			const resp = await fetch(VERSION_API, { cache: 'no-store' }); if (!resp.ok) return 'error';
			const json = await resp.json(); const data = json.data || json;
			if (data.version && isNewerVersion(data.version, APP_VERSION)) return 'found';
			return 'latest';
		} catch (e) { return 'error'; }
	}

	// ===== ÁîüÂëΩÂë®Êúü =====
	function onPanelReady(panelEl) {
		console.log('[AB] ‚úÖ AI Èù¢ÊùøÂ∑≤Ê£ÄÊµãÂà∞');
		createSettingsUI(panelEl);
		applyColorSettings(); applyFontsizeSettings();
		applyCopySettings(panelEl); applyHotkeySettings();
		applyAutoAcceptSettings(panelEl);
		if (currentSettings.latexEnabled) applyLatexSettings(panelEl);
		if (currentSettings.autoUpdateEnabled) setTimeout(checkForUpdate, 10000);
	}
	function waitForAgentPanel() {
		const p = document.querySelector('.antigravity-agent-side-panel');
		if (p) { onPanelReady(p); return; }
		const obs = new MutationObserver((_, o) => { const p = document.querySelector('.antigravity-agent-side-panel'); if (p) { o.disconnect(); onPanelReady(p); } });
		obs.observe(document.body, { childList: true, subtree: true });
		console.log('[AB] ‚è≥ Á≠âÂæÖ AI Èù¢ÊùøÂá∫Áé∞...');
	}
	function init() {
		console.log('[AB] ÂºÄÂßãÂàùÂßãÂåñ...');
		try { applyColorSettings(); applyFontsizeSettings(); waitForAgentPanel(); console.log('[AB] ‚úÖ ÂàùÂßãÂåñÂÆåÊàê'); } catch (e) { console.error('[AB] ‚ùå ÂàùÂßãÂåñÂ§±Ë¥•:', e); }
	}
	if (document.body) { setTimeout(init, 1000); } else { document.addEventListener('DOMContentLoaded', () => setTimeout(init, 1000)); }
})();
</script>

</html>